{
  "name": "aiops-orchestrator",
  "nodes": [
    {
      "parameters": {
        "path": "jobs/preview",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "1",
      "name": "Webhook (jobs.Preview)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        260,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const input = $json;\nconst normalizedEvent = input.normalized_event ?? {};\nconst policyContext = input.policy_context ?? {};\n\nconst limits = policyContext?.limits?.rag_router ?? {};\nconst topKDefaultRaw = limits.top_k_default ?? 5;\nconst topKCapRaw = limits.top_k_cap ?? 10;\nlet topK = Number.parseInt(String(topKDefaultRaw ?? 5), 10);\nif (!Number.isFinite(topK) || topK <= 0) topK = 5;\ntopK = Math.floor(topK);\nif (topK < 1) topK = 1;\nif (Number.isFinite(Number(topKCapRaw)) && topK > Number(topKCapRaw)) topK = Number(topKCapRaw);\n\nconst defaults = policyContext?.defaults?.rag_router ?? {};\nconst fallbacks = policyContext?.fallbacks?.rag_router ?? {};\nconst fallbackMode = fallbacks.mode ?? defaults.mode ?? 'kedb_documents';\nconst fallbackReason = fallbacks.reason ?? 'llm_failed_fallback_default';\nconst queryStrategy = fallbacks.query_strategy ?? defaults.query_strategy ?? 'normalized_event_text';\n\nconst query = queryStrategy === 'normalized_event_text'\n  ? (normalizedEvent.text ?? '')\n  : (normalizedEvent.text ?? '');\n\nconst filterFlags = fallbacks.filters ?? defaults.filters ?? {};\nconst filters = {\n  service_name: filterFlags.use_service_name ? (normalizedEvent.service_name ?? normalizedEvent.metadata?.service_name ?? null) : null,\n  ci_ref: filterFlags.use_ci_ref ? (normalizedEvent.ci_ref ?? normalizedEvent.metadata?.ci_ref ?? null) : null,\n  problem_number: filterFlags.use_problem_number ? (normalizedEvent.problem_number ?? null) : null,\n  known_error_number: filterFlags.use_known_error_number ? (normalizedEvent.known_error_number ?? null) : null,\n  problem_statuses: null\n};\n\nconst ragRoute = {\n  prompt_version: 'rag-router-fallback-ja-1',\n  prompt: null,\n  mode: fallbackMode,\n  reason: fallbackReason,\n  query,\n  top_k: topK,\n  filters\n};\n\nreturn [{ json: { ...input, rag_route: ragRoute } }];\n"
      },
      "id": "9",
      "name": "RAG Router (Basic)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        520,
        120
      ]
    },
    {
      "parameters": {
        "path": "jobs/enqueue",
        "httpMethod": "POST",
        "responseMode": "responseNode",
        "options": {}
      },
      "id": "2",
      "name": "Webhook (jobs.enqueue)",
      "type": "n8n-nodes-base.webhook",
      "typeVersion": 2,
      "position": [
        260,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\n\nconst base = $json ?? {};\nconst { context_id, actor, normalized_event, iam_context, policy_context } = base;\nif (!context_id || !normalized_event) throw new Error('context_id/normalized_event は必須です');\n\nconst preview = base.preview ?? null;\n\nconst normalizeArray = (value) => Array.isArray(value) ? value : [];\nconst normalizeStringArray = (value) => normalizeArray(value).map((v) => String(v ?? '').trim()).filter(Boolean);\n\nconst normalizeCandidate = (raw) => {\n  const c = raw && typeof raw === 'object' ? raw : {};\n  return {\n    workflow_id: c.workflow_id ?? c.workflowId ?? null,\n    params: c.params && typeof c.params === 'object' ? c.params : {},\n    summary: String(c.summary ?? '').trim(),\n    required_roles: normalizeStringArray(c.required_roles ?? c.requiredRoles),\n    required_groups: normalizeStringArray(c.required_groups ?? c.requiredGroups),\n    risk_level: String(c.risk_level ?? c.riskLevel ?? 'medium').toLowerCase(),\n    impact_scope: String(c.impact_scope ?? c.impactScope ?? 'service').toLowerCase(),\n    ambiguity_score: typeof c.ambiguity_score === 'number' ? c.ambiguity_score : (typeof c.ambiguityScore === 'number' ? c.ambiguityScore : 0)\n  };\n};\n\nconst fallback = () => {\n  const defaults = policy_context?.defaults?.jobs_preview ?? {};\n  const fallbackNextAction = defaults.next_action ?? 'ask_clarification';\n  return {\n    candidates: [],\n    next_action: fallbackNextAction,\n    required_confirm: true,\n    missing_params: [],\n    clarifying_questions: [],\n    confirmation_summary: '',\n    confidence: 0,\n    rationale: 'llm_preview_missing_or_invalid'\n  };\n};\n\nconst previewObj = (preview && typeof preview === 'object') ? preview : fallback();\nconst candidates = normalizeArray(previewObj.candidates).map(normalizeCandidate).filter((c) => c.workflow_id);\n\nconst nextAction = String(previewObj.next_action ?? '').trim() || (policy_context?.defaults?.jobs_preview?.next_action ?? 'ask_clarification');\nconst requiredConfirm = typeof previewObj.required_confirm === 'boolean'\n  ? previewObj.required_confirm\n  : null;\n\nconst missingParams = normalizeStringArray(previewObj.missing_params);\nconst clarifyingQuestions = normalizeStringArray(previewObj.clarifying_questions);\nconst confirmationSummary = String(previewObj.confirmation_summary ?? '').trim();\nconst confidence = typeof previewObj.confidence === 'number' ? previewObj.confidence : 0;\nconst rationale = String(previewObj.rationale ?? '').trim();\n\nconst topCandidate = candidates[0] ?? null;\n\nconst jobPlan = (nextAction !== 'reply_only' && topCandidate) ? {\n  workflow_id: topCandidate.workflow_id,\n  params: topCandidate.params ?? {},\n  trace_id: normalized_event.trace_id ?? null,\n  summary: topCandidate.summary ?? '',\n  required_roles: topCandidate.required_roles ?? [],\n  required_groups: topCandidate.required_groups ?? [],\n  risk_level: topCandidate.risk_level ?? 'medium',\n  impact_scope: topCandidate.impact_scope ?? 'service',\n  missing_params: missingParams\n} : {};\n\nlet approvalId = null;\nlet approvalToken = null;\nlet tokenNonce = null;\nlet expiresAt = null;\n\nconst tokenIssueActions = normalizeStringArray(policy_context?.defaults?.jobs_preview?.token_issue_actions);\nconst shouldIssueToken = tokenIssueActions.length > 0\n  ? tokenIssueActions.includes(nextAction)\n  : (nextAction === 'require_approval');\n\nif (shouldIssueToken && topCandidate && jobPlan.workflow_id) {\n  const secret = $env.N8N_APPROVAL_HMAC_SECRET_NAME;\n  if (secret) {\n    const ttlSecondsRaw = policy_context?.approval_policy_doc?.token?.ttl_seconds ?? $env.N8N_APPROVAL_TOKEN_TTL_SECONDS ?? 900;\n    const ttlSeconds = (typeof ttlSecondsRaw === 'number' && Number.isFinite(ttlSecondsRaw))\n      ? Math.max(1, Math.floor(ttlSecondsRaw))\n      : Math.max(1, Math.floor(Number(ttlSecondsRaw) || 900));\n\n    approvalId = crypto.randomUUID();\n    tokenNonce = crypto.randomBytes(16).toString('hex');\n    expiresAt = new Date(Date.now() + ttlSeconds * 1000).toISOString();\n\n    const tokenPayload = {\n      approval_id: approvalId,\n      context_id,\n      workflow_id: jobPlan.workflow_id,\n      params: jobPlan.params ?? {},\n      actor,\n      token_nonce: tokenNonce,\n      expires_at: expiresAt\n    };\n\n    const signature = crypto.createHmac('sha256', secret)\n      .update(JSON.stringify(tokenPayload))\n      .digest('hex');\n\n    approvalToken = Buffer.from(JSON.stringify({ ...tokenPayload, signature })).toString('base64url');\n  }\n}\n\nconst previewFacts = {\n  candidate_source: base.candidate_source ?? null,\n  rag_context: {\n    mode: base.rag_mode ?? null,\n    query: base.rag_query ?? null,\n    filters: base.rag_filters ?? {},\n    top_k: base.rag_top_k ?? null\n  },\n  catalog_count: Array.isArray(base.catalog) ? base.catalog.length : 0,\n  feedback_count: Array.isArray(base.feedback) ? base.feedback.length : 0,\n  approval_history_count: Array.isArray(base.approval_history) ? base.approval_history.length : 0\n};\n\nreturn [{\n  json: {\n    ...base,\n    iam_context,\n    policy_context,\n    candidates,\n    preview_facts: previewFacts,\n    job_plan: jobPlan,\n    approval_id: approvalId,\n    approval_token: approvalToken,\n    token_nonce: tokenNonce,\n    expires_at: expiresAt,\n    required_confirm: requiredConfirm,\n    next_action: nextAction,\n    missing_params: missingParams,\n    clarifying_questions: clarifyingQuestions,\n    confirmation_summary: confirmationSummary,\n    confidence,\n    rationale\n  }\n}];\n"
      },
      "id": "3",
      "name": "Build Job Plan + Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        520,
        240
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH v AS (\n  SELECT\n    NULLIF(NULLIF('{{$json.approval_id}}', ''), 'null')::uuid AS approval_id,\n    NULLIF(NULLIF('{{$json.context_id}}',''), 'undefined')::uuid AS context_id,\n    COALESCE(NULLIF('{{ JSON.stringify($json.job_plan || {}) }}','undefined')::jsonb, '{}'::jsonb) AS job_plan,\n    COALESCE(NULLIF(NULLIF(NULLIF('{{$json.required_confirm}}',''), 'undefined'), 'null')::boolean, false) AS required_confirm,\n    NULLIF(NULLIF('{{$json.token_nonce}}', ''), 'null') AS token_nonce,\n    NULLIF(NULLIF('{{$json.expires_at}}', ''), 'null')::timestamptz AS expires_at,\n    COALESCE(NULLIF('{{ JSON.stringify($json.candidates || []) }}','undefined')::jsonb, '[]'::jsonb) AS candidates,\n    COALESCE(NULLIF('{{ JSON.stringify($json.preview_facts || {}) }}','undefined')::jsonb, '{}'::jsonb) AS preview_facts,\n    NULLIF(NULLIF('{{$json.approval_token}}', ''), 'null') AS approval_token\n), ctx AS (\n  SELECT 1 AS ok\n  FROM aiops_context c\n  WHERE c.context_id = (SELECT context_id FROM v)\n  LIMIT 1\n), ins AS (\n  INSERT INTO aiops_pending_approvals (approval_id, context_id, job_plan, required_confirm, token_nonce, expires_at)\n  SELECT v.approval_id, v.context_id, v.job_plan, v.required_confirm, v.token_nonce, v.expires_at\n  FROM v\n  WHERE v.approval_id IS NOT NULL AND v.context_id IS NOT NULL\n    AND EXISTS (SELECT 1 FROM ctx)\n  ON CONFLICT (approval_id) DO NOTHING\n  RETURNING approval_id\n)\nSELECT\n  v.approval_id,\n  v.context_id,\n  v.job_plan,\n  v.required_confirm,\n  v.token_nonce,\n  v.expires_at,\n  v.candidates,\n  v.preview_facts,\n  v.approval_token,\n  EXISTS (SELECT 1 FROM ctx) AS context_exists,\n  EXISTS (SELECT 1 FROM ins) AS inserted\nFROM v;\n"
      },
      "id": "4",
      "name": "Save Pending Approval",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        760,
        240
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { context_id: $json.context_id, candidates: $json.candidates, preview_facts: $json.preview_facts, job_plan: $json.job_plan, next_action: $node['Build Job Plan + Token'].json.next_action, required_confirm: $json.required_confirm, missing_params: $node['Build Job Plan + Token'].json.missing_params, clarifying_questions: $node['Build Job Plan + Token'].json.clarifying_questions, confirmation_summary: $node['Build Job Plan + Token'].json.confirmation_summary, confidence: $node['Build Job Plan + Token'].json.confidence, rationale: $node['Build Job Plan + Token'].json.rationale, approval: { approval_id: $json.approval_id, expires_at: $json.expires_at, token: $json.approval_token }, approval_id: $json.approval_id, approval_token: $json.approval_token, token_nonce: $json.token_nonce, expires_at: $json.expires_at } }}",
        "options": {}
      },
      "id": "5",
      "name": "Return Preview",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1000,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\n\nconst error = (message) => {\n  throw new Error(message);\n};\n\nconst request = $json ?? {};\nconst base = (request && typeof request === 'object' && request.body && typeof request.body === 'object' && !Array.isArray(request.body))\n  ? request.body\n  : request;\n\nconst { job_plan, approval_token, context_id } = base;\nif (!job_plan || !approval_token) error('job_plan と approval_token は必須です');\n\nconst secret = $env.N8N_APPROVAL_HMAC_SECRET_NAME;\nif (!secret) error('N8N_APPROVAL_HMAC_SECRET_NAME が未設定です');\n\nconst decoded = JSON.parse(Buffer.from(String(approval_token), 'base64url').toString('utf8'));\nconst { signature, ...payload } = decoded;\nconst expected = crypto.createHmac('sha256', secret).update(JSON.stringify(payload)).digest('hex');\nif (signature !== expected) error('approval_token の署名が不正です');\n\nif (new Date(payload.expires_at).getTime() < Date.now()) error('approval_token の有効期限が切れています');\n\nif (context_id && payload.context_id && context_id !== payload.context_id) {\n  error('context_id が一致しません');\n}\n\nconst plan = job_plan ?? {};\nif (payload.workflow_id && plan.workflow_id && payload.workflow_id !== plan.workflow_id) {\n  error('workflow_id が一致しません');\n}\n\nconst sortKeysDeep = (value) => {\n  if (Array.isArray(value)) return value.map(sortKeysDeep);\n  if (value && typeof value === 'object') {\n    return Object.keys(value).sort().reduce((acc, key) => {\n      acc[key] = sortKeysDeep(value[key]);\n      return acc;\n    }, {});\n  }\n  return value;\n};\n\nconst stableStringify = (value) => JSON.stringify(sortKeysDeep(value));\nconst paramsHash = crypto.createHash('sha256').update(stableStringify(plan.params ?? {})).digest('hex');\nif (payload.params_hash && payload.params_hash !== paramsHash) {\n  error('params_hash が一致しません');\n}\n\nreturn [{ json: { context_id: payload.context_id, approval_id: payload.approval_id, job_plan } }];\n"
      },
      "id": "6",
      "name": "Verify Token (enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        520,
        520
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "WITH ctx AS (\n  SELECT source, normalized_event\n  FROM aiops_context\n  WHERE context_id = NULLIF(NULLIF('{{$json.context_id}}',''), 'undefined')::uuid\n  LIMIT 1\n)\nSELECT source, normalized_event\nFROM ctx\n\nUNION ALL\n\nSELECT NULL::text AS source, NULL::jsonb AS normalized_event\nWHERE NOT EXISTS (SELECT 1 FROM ctx);"
      },
      "id": "55",
      "name": "Load Context (enqueue)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        720,
        620
      ]
    },
    {
      "parameters": {
        "jsCode": "const base = $node['Verify Token (enqueue)'].json ?? {};\nconst ctx = $json ?? {};\n\nconst source = String(ctx.source ?? ctx.normalized_event?.source ?? '').trim();\nconst isMonitoringSource = source === 'cloudwatch' || source.startsWith('cloudwatch_');\n\nconst boolDefaultTrue = (value) => (value === undefined || value === null) ? true : Boolean(value);\n\nconst plan = base.job_plan ?? {};\nconst workflowId = String(plan.workflow_id ?? '').trim();\nif (!workflowId) {\n  return [{ json: base }];\n}\n\nif (!isMonitoringSource) {\n  return [{ json: base }];\n}\n\nconst apiKey = $env.N8N_API_KEY || $env.N8N_API_KEY;\nif (!apiKey) throw new Error('N8N_API_KEY is not set');\n\nconst baseUrlRaw = $env.N8N_INTERNAL_API_BASE_URL || $env.N8N_PUBLIC_API_BASE_URL || 'http://127.0.0.1:5678';\nconst baseUrl = String(baseUrlRaw).replace(/\\/$/, '');\n\nlet wf;\ntry {\n  const response = await this.helpers.httpRequest({\n    method: 'GET',\n    url: `${baseUrl}/api/v1/workflows/${workflowId}`,\n    qs: { excludePinnedData: true },\n    json: true,\n    headers: {\n      'X-N8N-API-KEY': apiKey\n    }\n  });\n  wf = response?.data ?? response;\n} catch (error) {\n  const msg = error?.message ? String(error.message) : String(error);\n  throw new Error(`workflow lookup failed: ${msg}`);\n}\n\nconst catalog = wf?.meta?.aiops_catalog ?? wf?.aiops_catalog ?? null;\nif (!catalog || typeof catalog !== 'object') {\n  throw new Error('このワークフローはカタログ未設定のため、システムモニタリングから実行できません');\n}\n\nif (!boolDefaultTrue(catalog.available)) {\n  throw new Error('このワークフローは利用不可(available=false)のため実行できません');\n}\n\nif (!boolDefaultTrue(catalog.available_from_monitoring ?? catalog.availableFromMonitoring)) {\n  throw new Error('このワークフローはシステムモニタリングからの実行が許可されていません');\n}\n\nreturn [{ json: base }];\n"
      },
      "id": "56",
      "name": "Check Workflow Availability (enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        620
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "UPDATE aiops_pending_approvals\nSET approved_at = COALESCE(approved_at, NOW()), used_at = NOW()\nWHERE approval_id = NULLIF(NULLIF('{{$json.approval_id}}',''), 'undefined')::uuid\n  AND context_id = NULLIF(NULLIF('{{$json.context_id}}',''), 'undefined')::uuid\n  AND used_at IS NULL\nRETURNING approval_id;"
      },
      "id": "7",
      "name": "Consume Approval",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        760,
        520
      ]
    },
    {
      "parameters": {
        "respondWith": "json",
        "responseBody": "={{ { ok: true, context_id: $node['Ensure Approval Consumed'].json.context_id, job_id: $json.job_id, status: $json.status ?? 'accepted' } }}",
        "options": {}
      },
      "id": "8",
      "name": "Return Enqueue Ack",
      "type": "n8n-nodes-base.respondToWebhook",
      "typeVersion": 1,
      "position": [
        1000,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const ragRoute = $json.rag_route ?? {};\nconst filters = ragRoute.filters ?? {};\nconst policyContext = $json.policy_context ?? {};\n\nconst sanitizeSqlString = (value) => {\n  if (value === null || value === undefined) return null;\n  const cleaned = String(value).trim();\n  if (!cleaned) return null;\n  return cleaned.replace(/'/g, \"''\");\n};\n\nconst sanitizeVocab = (value) => {\n  if (value === null || value === undefined) return null;\n  const cleaned = String(value).trim().toLowerCase();\n  if (!cleaned) return null;\n  return cleaned.replace(/'/g, \"''\");\n};\n\nconst rawQuery = ragRoute.query ?? '';\nconst sanitizedQuery = sanitizeSqlString(rawQuery) ?? '';\n\nconst limits = policyContext?.limits?.rag_router ?? {};\nconst topKDefaultRaw = limits.top_k_default ?? 5;\nconst topKCapRaw = limits.top_k_cap ?? 10;\nconst topKDefault = Number.isFinite(Number(topKDefaultRaw)) ? Number(topKDefaultRaw) : 5;\nconst topKCap = Number.isFinite(Number(topKCapRaw)) ? Number(topKCapRaw) : 10;\n\nconst rawTopK = ragRoute.top_k;\nlet topK = Number.parseInt(String(rawTopK ?? ''), 10);\nif (!Number.isFinite(topK) || topK <= 0) topK = topKDefault;\ntopK = Math.floor(topK);\nif (topK < 1) topK = 1;\nif (Number.isFinite(topKCap) && topK > topKCap) topK = topKCap;\n\nconst allowedStatuses = Array.isArray(policyContext?.taxonomy?.problem_status_open_vocab)\n  ? new Set(policyContext.taxonomy.problem_status_open_vocab.map((v) => String(v).trim().toLowerCase()).filter(Boolean))\n  : null;\n\nlet problemStatuses = Array.isArray(filters.problem_statuses)\n  ? filters.problem_statuses\n      .map((v) => sanitizeVocab(v))\n      .filter((v) => v)\n  : [];\n\nif (allowedStatuses) {\n  problemStatuses = problemStatuses.filter((v) => allowedStatuses.has(v));\n}\n\nproblemStatuses = [...new Set(problemStatuses)].slice(0, 20);\n\nconst problemStatusesSql = problemStatuses.length > 0\n  ? `ARRAY[${problemStatuses.map((v) => `'${v}'`).join(',')}]::text[]`\n  : null;\n\nconst allowedDomains = Array.isArray(policyContext?.taxonomy?.management_domain_vocab)\n  ? new Set(policyContext.taxonomy.management_domain_vocab.map((v) => String(v).trim().toLowerCase()).filter(Boolean))\n  : null;\n\nconst rawDomains = Array.isArray(filters.management_domains)\n  ? filters.management_domains\n  : (filters.management_domain ? [filters.management_domain] : []);\n\nlet managementDomains = rawDomains\n  .map((v) => sanitizeVocab(v))\n  .filter((v) => v);\n\nif (allowedDomains) {\n  managementDomains = managementDomains.filter((v) => allowedDomains.has(v));\n}\n\nmanagementDomains = [...new Set(managementDomains)].slice(0, 10);\n\nconst managementDomainsSql = managementDomains.length > 0\n  ? `ARRAY[${managementDomains.map((v) => `'${v}'`).join(',')}]::text[]`\n  : null;\n\nreturn [\n  {\n    json: {\n      ...$json,\n      rag_mode: ragRoute?.mode ?? 'none',\n      rag_query: sanitizedQuery,\n      rag_top_k: topK,\n      rag_filters: {\n        service_name: sanitizeSqlString(filters.service_name),\n        ci_ref: sanitizeSqlString(filters.ci_ref),\n        problem_number: sanitizeSqlString(filters.problem_number),\n        known_error_number: sanitizeSqlString(filters.known_error_number),\n        problem_statuses: problemStatuses,\n        problem_statuses_sql: problemStatusesSql,\n        management_domains: managementDomains,\n        management_domains_sql: managementDomainsSql\n      }\n    }\n  }\n];\n"
      },
      "id": "10",
      "name": "Enrich RAG Route",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        840,
        120
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.rag_mode}}",
              "value2": "kedb_documents"
            }
          ]
        }
      },
      "id": "11",
      "name": "IF 既知エラーDB Mode",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1040,
        120
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  d.document_id,\n  d.content,\n  (\n    {{ $json.rag_query ? `ts_rank_cd(to_tsvector('simple', d.content), plainto_tsquery('simple', '${$json.rag_query}'))` : '0' }}\n    + {{ $json.rag_filters?.service_name ? `0.2` : '0' }}\n    + {{ $json.rag_filters?.ci_ref ? `0.2` : '0' }}\n  ) AS rag_score,\n  ke.known_error_id,\n  ke.title AS known_error_title,\n  ke.risk_level AS known_error_risk_level,\n  ke.service_name,\n  ke.ci_ref,\n  w.workaround_id,\n  w.title AS workaround_title,\n  w.automation_hint\nFROM itsm_kedb_documents d\nLEFT JOIN itsm_known_error ke ON ke.known_error_id = d.known_error_id\nLEFT JOIN itsm_workaround w ON w.workaround_id = ke.workaround_id\nWHERE d.active\n  AND (\n    {{$json.rag_query ? `to_tsvector('simple', d.content) @@ plainto_tsquery('simple', '${$json.rag_query}')` : 'false'}}\n    OR {{$json.rag_filters?.service_name ? `d.metadata->>'service_name' = '${$json.rag_filters.service_name}'` : 'false'}}\n    OR {{$json.rag_filters?.ci_ref ? `d.metadata->>'ci_ref' = '${$json.rag_filters.ci_ref}'` : 'false'}}\n  )\nORDER BY\n  rag_score DESC,\n  d.updated_at DESC\nLIMIT {{$json.rag_top_k}};"
      },
      "id": "12",
      "name": "Query 既知エラーDB Candidate",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1240,
        100
      ]
    },
    {
      "parameters": {
        "values": {
          "boolean": [],
          "number": [],
          "string": [
            {
              "name": "context_id",
              "value": "={{ $node['Enrich RAG Route'].json.context_id }}"
            },
            {
              "name": "actor",
              "value": "={{ $node['Enrich RAG Route'].json.actor }}"
            },
            {
              "name": "normalized_event",
              "value": "={{ $node['Enrich RAG Route'].json.normalized_event }}"
            },
            {
              "name": "iam_context",
              "value": "={{ $node['Enrich RAG Route'].json.iam_context }}"
            },
            {
              "name": "policy_context",
              "value": "={{ $node['Enrich RAG Route'].json.policy_context }}"
            },
            {
              "name": "rag_route",
              "value": "={{ $node['Enrich RAG Route'].json.rag_route }}"
            },
            {
              "name": "rag_mode",
              "value": "={{ $node['Enrich RAG Route'].json.rag_mode }}"
            },
            {
              "name": "rag_filters",
              "value": "={{ $node['Enrich RAG Route'].json.rag_filters }}"
            },
            {
              "name": "candidate_source",
              "value": "kedb_documents"
            },
            {
              "name": "candidate",
              "value": "={{ $node['Select 既知エラーDB Candidate'].json.candidate }}"
            },
            {
              "name": "candidate_list",
              "value": "={{ $node['Select 既知エラーDB Candidate'].json.candidates }}"
            }
          ],
          "collection": []
        },
        "options": {}
      },
      "id": "13",
      "name": "Set 既知エラーDB Candidate Context",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        1520,
        120
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT\n  ke.known_error_id,\n  ke.known_error_number,\n  ke.title AS known_error_title,\n  ke.risk_level,\n  ke.service_name,\n  ke.ci_ref,\n  w.workaround_id,\n  w.automation_hint,\n  p.problem_id,\n  p.problem_number,\n  p.status,\n  (\n    CASE\n      WHEN {{$json.rag_filters?.problem_number ? `p.problem_number = '${$json.rag_filters.problem_number}'` : 'false'}} THEN 3\n      WHEN {{$json.rag_filters?.known_error_number ? `ke.known_error_number = '${$json.rag_filters.known_error_number}'` : 'false'}} THEN 2\n      WHEN {{$json.rag_filters?.problem_statuses_sql ? `p.status = ANY(${$json.rag_filters.problem_statuses_sql})` : 'false'}} THEN 1\n      ELSE 0\n    END\n  ) AS rag_score\nFROM itsm_known_error ke\nLEFT JOIN itsm_workaround w ON w.workaround_id = ke.workaround_id\nLEFT JOIN itsm_problem p ON p.problem_id = ke.problem_id\nWHERE ke.status = 'published'\n  AND (\n    {{$json.rag_filters?.problem_number ? `p.problem_number = '${$json.rag_filters.problem_number}'` : 'false'}}\n    OR {{$json.rag_filters?.known_error_number ? `ke.known_error_number = '${$json.rag_filters.known_error_number}'` : 'false'}}\n    OR {{$json.rag_filters?.problem_statuses_sql ? `p.status = ANY(${$json.rag_filters.problem_statuses_sql})` : 'false'}}\n  )\nORDER BY rag_score DESC, p.updated_at DESC\nLIMIT {{$json.rag_top_k}};"
      },
      "id": "14",
      "name": "Query Problem Candidate",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1240,
        320
      ]
    },
    {
      "parameters": {
        "values": {
          "boolean": [],
          "number": [],
          "string": [
            {
              "name": "context_id",
              "value": "={{ $node['Enrich RAG Route'].json.context_id }}"
            },
            {
              "name": "actor",
              "value": "={{ $node['Enrich RAG Route'].json.actor }}"
            },
            {
              "name": "normalized_event",
              "value": "={{ $node['Enrich RAG Route'].json.normalized_event }}"
            },
            {
              "name": "iam_context",
              "value": "={{ $node['Enrich RAG Route'].json.iam_context }}"
            },
            {
              "name": "policy_context",
              "value": "={{ $node['Enrich RAG Route'].json.policy_context }}"
            },
            {
              "name": "rag_route",
              "value": "={{ $node['Enrich RAG Route'].json.rag_route }}"
            },
            {
              "name": "rag_mode",
              "value": "={{ $node['Enrich RAG Route'].json.rag_mode }}"
            },
            {
              "name": "rag_filters",
              "value": "={{ $node['Enrich RAG Route'].json.rag_filters }}"
            },
            {
              "name": "candidate_source",
              "value": "problem_management"
            },
            {
              "name": "candidate",
              "value": "={{ $node['Select Problem Candidate'].json.candidate }}"
            },
            {
              "name": "candidate_list",
              "value": "={{ $node['Select Problem Candidate'].json.candidates }}"
            }
          ],
          "collection": []
        },
        "options": {}
      },
      "id": "15",
      "name": "Set Problem Candidate Context",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        1520,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const consumed = $input.all();\nconst payload = $node['Verify Token (enqueue)'].json ?? {};\nif (!consumed.length) {\n  throw new Error('承認が見つからないか、既に使用済みです');\n}\n\nreturn [{ json: { ...payload, approval_consumed: true } }];\n"
      },
      "id": "16",
      "name": "Ensure Approval Consumed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        520
      ]
    },
    {
      "parameters": {
        "url": "={{(() => {\n  const pick = (...vals) => {\n    for (const v of vals) {\n      if (v === null || v === undefined) continue;\n      const s = String(v).trim();\n      if (s) return s;\n    }\n    return '';\n  };\n\n  const tryNodeWebhookUrl = (name) => {\n    try {\n      const node = $node[name];\n      const url = node && node.json && node.json.webhookUrl;\n      return url ? String(url) : '';\n    } catch (e) {\n      return '';\n    }\n  };\n\n  const candidate = pick(\n    $env.N8N_JOB_ENGINE_BASE_URL,\n    $env.N8N_WEBHOOK_BASE_URL,\n    $env.N8N_ORCHESTRATOR_BASE_URL,\n    $env.N8N_ADAPTER_BASE_URL,\n    $json && ($json.webhookUrl || $json.webhook_url),\n    tryNodeWebhookUrl('Webhook (jobs.enqueue)'),\n    tryNodeWebhookUrl('Webhook (jobs.Preview)'),\n    tryNodeWebhookUrl('Verify Token (enqueue)')\n  );\n\n  let base = String(candidate ?? '').trim().replace(/\\/+$/, '');\n  if (!base) return '';\n\n  // webhookUrl 形式（.../webhook/<path>）の場合は /webhook までを切り出す\n  if (base.includes('/webhook/')) {\n    base = base.replace(/\\/webhook\\/.*/, '/webhook');\n  }\n\n  // /webhook が無い場合は補う\n  const webhookIndex = base.indexOf('/webhook');\n  if (webhookIndex >= 0) {\n    base = base.slice(0, webhookIndex) + '/webhook';\n  } else {\n    base = base + '/webhook';\n  }\n\n  base = base.replace(/\\/+$/, '');\n  return base + '/jobs/job-engine/enqueue';\n})()}}",
        "method": "POST",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ { context_id: $json.context_id, job_plan: $json.job_plan, trace_id: $json.job_plan?.trace_id } }}",
        "options": {
          "timeout": 20000
        }
      },
      "id": "17",
      "name": "Enqueue Job Engine",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4,
      "position": [
        1120,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\n\nconst request = $json ?? {};\nconst base = (request && typeof request === 'object' && request.body && typeof request.body === 'object' && !Array.isArray(request.body))\n  ? request.body\n  : request;\n\nconst ragRoute = base.rag_route ?? null;\n\nconst promptText = \"__PROMPT__RAG_ROUTER__\";\nconst promptHash = crypto.createHash('sha256').update(promptText).digest('hex');\n\nreturn [{\n  json: {\n    ...base,\n    rag_route: ragRoute,\n    prompt_key: 'orchestrator.rag_router.v1',\n    prompt_version: 'ja-1',\n    prompt_text: promptText,\n    prompt_hash: promptHash,\n    prompt_input: JSON.stringify({\n      policy_context: base.policy_context ?? {},\n      normalized_event: base.normalized_event ?? {}\n    })\n  }\n}];\n"
      },
      "id": "18",
      "name": "Apply RAG Route (Input)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        520,
        -40
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO aiops_prompt_history (prompt_key, prompt_version, prompt_text, prompt_hash, source_workflow, source_node)\nVALUES (\n  '{{ String($json.prompt_key ?? \"\").replace(/'/g, \"''\") }}',\n  '{{ String($json.prompt_version ?? \"\").replace(/'/g, \"''\") }}',\n  '{{ String($json.prompt_text ?? \"\").replace(/'/g, \"''\") }}',\n  '{{ String($json.prompt_hash ?? \"\").replace(/'/g, \"''\") }}',\n  'aiops-orchestrator',\n  'OpenAI RAG Router'\n)\nON CONFLICT (prompt_key, prompt_hash) DO NOTHING;"
      },
      "id": "19",
      "name": "Record Prompt History (RAG)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        740,
        -40
      ]
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "complete",
        "model": "={{$env.OPENAI_MODEL || 'gpt-4o-mini'}}",
        "prompt": {
          "messages": [
            {
              "role": "system",
              "content": "={{ $node['Apply RAG Route (Input)'].json.prompt_text }}"
            },
            {
              "role": "user",
              "content": "={{ '入力:\\n' + $node['Apply RAG Route (Input)'].json.prompt_input }}"
            }
          ]
        },
        "options": {
          "temperature": 0.2,
          "baseURL": "={{$env.OPENAI_BASE_URL}}",
          "maxTokens": "={{$json.policy_context?.limits?.llm_output_tokens || 1200}}"
        }
      },
      "id": "20",
      "name": "OpenAI RAG Router",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        960,
        -40
      ],
      "credentials": {
        "openAiApi": {
          "name": "aiops-openai"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const base = $node['Apply RAG Route (Input)'].json ?? {};\nconst response = $json ?? {};\n\nconst extractContent = (payload) => {\n  if (!payload) return '';\n  if (typeof payload === 'string') return payload;\n  return payload?.message?.content\n    ?? payload?.choices?.[0]?.message?.content\n    ?? payload?.choices?.[0]?.text\n    ?? payload?.data?.choices?.[0]?.message?.content\n    ?? payload?.data?.choices?.[0]?.text\n    ?? payload?.content\n    ?? '';\n};\n\nconst rawContent = extractContent(response);\nlet parsed = null;\nif (typeof rawContent === 'string') {\n  try {\n    parsed = JSON.parse(rawContent);\n  } catch (error) {\n    const match = rawContent.match(/\\{[\\s\\S]*\\}/);\n    if (match) {\n      try {\n        parsed = JSON.parse(match[0]);\n      } catch (inner) {\n        parsed = null;\n      }\n    }\n  }\n} else if (rawContent && typeof rawContent === 'object') {\n  parsed = rawContent;\n}\n\nconst policyContext = base.policy_context ?? {};\nconst defaults = policyContext?.defaults?.rag_router ?? {};\nconst fallbacks = policyContext?.fallbacks?.rag_router ?? {};\nconst allowedModes = Array.isArray(policyContext?.taxonomy?.rag_mode_vocab)\n  ? new Set(policyContext.taxonomy.rag_mode_vocab)\n  : null;\nconst maxClarifying = Number.isFinite(Number(policyContext?.limits?.rag_router?.max_clarifying_questions))\n  ? Math.max(0, Math.floor(Number(policyContext.limits.rag_router.max_clarifying_questions)))\n  : null;\n\nif (!parsed || typeof parsed !== 'object') {\n  return [{ json: { ...base, llm_ok: false, llm_error: 'invalid_llm_response' } }];\n}\n\nconst rawMode = parsed.rag_mode ?? parsed.mode ?? null;\nconst mode = (typeof rawMode === 'string' && (!allowedModes || allowedModes.has(rawMode)))\n  ? rawMode\n  : (fallbacks.mode ?? defaults.mode ?? 'kedb_documents');\n\nconst clarifyingQuestions = Array.isArray(parsed.clarifying_questions)\n  ? (maxClarifying === null ? parsed.clarifying_questions : parsed.clarifying_questions.slice(0, maxClarifying))\n  : [];\n\nconst ragRoute = {\n  prompt_version: 'rag-router-ja-1',\n  prompt: base.prompt_text ?? null,\n  mode,\n  reason: parsed.reason ?? fallbacks.reason ?? null,\n  query: parsed.query ?? (base.normalized_event?.text ?? ''),\n  top_k: parsed.top_k ?? null,\n  filters: parsed.filters ?? {},\n  needs_clarification: Boolean(parsed.needs_clarification),\n  clarifying_questions: clarifyingQuestions,\n  confidence: typeof parsed.confidence === 'number' ? parsed.confidence : null\n};\n\nreturn [{\n  json: {\n    ...base,\n    rag_route: ragRoute,\n    llm_ok: true,\n    llm_output: parsed\n  }\n}];\n"
      },
      "id": "21",
      "name": "Parse RAG Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1180,
        -40
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$json.llm_ok}}",
              "value2": true
            }
          ]
        }
      },
      "id": "22",
      "name": "IF RAG Route OK",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1400,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const crypto = require('crypto');\n\nconst normalizedEvent = { ...($json.normalized_event ?? {}) };\ndelete normalizedEvent.raw_headers;\ndelete normalizedEvent.raw_body;\n\nconst payload = {\n  context_id: $json.context_id,\n  actor: $json.actor,\n  normalized_event: normalizedEvent,\n  iam_context: $json.iam_context,\n  policy_context: $json.policy_context,\n  rag_route: $json.rag_route,\n  rag_mode: $json.rag_mode,\n  rag_filters: $json.rag_filters,\n  candidate_source: $json.candidate_source,\n  candidate: $json.candidate,\n  candidate_list: $json.candidate_list ?? null,\n  catalog: $json.catalog ?? null,\n  feedback: $json.feedback ?? null,\n  approval_history: $json.approval_history ?? null\n};\n\nconst promptText = \"__PROMPT__JOBS_PREVIEW__\";\n\nconst promptHash = crypto.createHash('sha256').update(promptText).digest('hex');\n\nreturn [{\n  json: {\n    ...$json,\n    prompt_key: 'orchestrator.preview.v1',\n    prompt_version: 'ja-1',\n    prompt_text: promptText,\n    prompt_hash: promptHash,\n    prompt_input: JSON.stringify(payload)\n  }\n}];\n"
      },
      "id": "23",
      "name": "Build Preview Prompt (JP)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1760,
        220
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "INSERT INTO aiops_prompt_history (prompt_key, prompt_version, prompt_text, prompt_hash, source_workflow, source_node)\nVALUES (\n  '{{ String($json.prompt_key ?? \"\").replace(/'/g, \"''\") }}',\n  '{{ String($json.prompt_version ?? \"\").replace(/'/g, \"''\") }}',\n  '{{ String($json.prompt_text ?? \"\").replace(/'/g, \"''\") }}',\n  '{{ String($json.prompt_hash ?? \"\").replace(/'/g, \"''\") }}',\n  'aiops-orchestrator',\n  'OpenAI Jobs Preview'\n)\nON CONFLICT (prompt_key, prompt_hash) DO NOTHING;"
      },
      "id": "24",
      "name": "Record Prompt History (Preview)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1980,
        220
      ]
    },
    {
      "parameters": {
        "resource": "chat",
        "operation": "complete",
        "model": "={{$env.OPENAI_MODEL || 'gpt-4o-mini'}}",
        "prompt": {
          "messages": [
            {
              "role": "system",
              "content": "={{ $node['Build Preview Prompt (JP)'].json.prompt_text }}"
            },
            {
              "role": "user",
              "content": "={{ '入力:\\n' + $node['Build Preview Prompt (JP)'].json.prompt_input }}"
            }
          ]
        },
        "options": {
          "temperature": 0.2,
          "baseURL": "={{$env.OPENAI_BASE_URL}}",
          "maxTokens": "={{$json.policy_context?.limits?.llm_output_tokens || 1200}}"
        }
      },
      "id": "25",
      "name": "OpenAI Jobs Preview",
      "type": "n8n-nodes-base.openAi",
      "typeVersion": 1,
      "position": [
        2200,
        220
      ],
      "credentials": {
        "openAiApi": {
          "name": "aiops-openai"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "const base = $node['Build Preview Prompt (JP)'].json ?? {};\nconst response = $json ?? {};\n\nconst extractContent = (payload) => {\n  if (!payload) return '';\n  if (typeof payload === 'string') return payload;\n  return payload?.message?.content\n    ?? payload?.choices?.[0]?.message?.content\n    ?? payload?.choices?.[0]?.text\n    ?? payload?.data?.choices?.[0]?.message?.content\n    ?? payload?.data?.choices?.[0]?.text\n    ?? payload?.content\n    ?? '';\n};\n\nconst rawContent = extractContent(response);\nlet parsed = null;\nif (typeof rawContent === 'string') {\n  try {\n    parsed = JSON.parse(rawContent);\n  } catch (error) {\n    const match = rawContent.match(/\\{[\\s\\S]*\\}/);\n    if (match) {\n      try {\n        parsed = JSON.parse(match[0]);\n      } catch (inner) {\n        parsed = null;\n      }\n    }\n  }\n} else if (rawContent && typeof rawContent === 'object') {\n  parsed = rawContent;\n}\n\nif (!parsed || typeof parsed !== 'object') {\n  return [{ json: { ...base, llm_ok: false, llm_error: 'invalid_llm_response' } }];\n}\n\nreturn [{\n  json: {\n    ...base,\n    preview: parsed,\n    llm_ok: true,\n    llm_output: parsed\n  }\n}];\n"
      },
      "id": "26",
      "name": "Parse Preview Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2420,
        220
      ]
    },
    {
      "parameters": {
        "jsCode": "const base = $json ?? {};\nconst preview = (base.preview && typeof base.preview === 'object') ? { ...base.preview } : {};\nconst normalized = base.normalized_event ?? {};\n\nconst approvalPolicy = String(base.approval_policy ?? base.policy_context?.approval_policy ?? 'default').trim() || 'default';\nconst policyEntry = base.policy_context?.approval_policy_doc?.policies?.[approvalPolicy] ?? {};\nconst force = policyEntry.force_required_confirm === true;\nconst defaultRequired = policyEntry.default_required_confirm === true;\n\nconst runWindow = String(base.run_window ?? base.policy_context?.run_window ?? '').trim().toLowerCase();\n// 監視通知では run_window が空のことがあるため、空の場合も 24x7 相当として扱う\nconst is24x7 = runWindow === '' || runWindow === '24x7' || runWindow === '24/7' || runWindow === 'always' || runWindow === '24h';\n\nconst hay = JSON.stringify(normalized).toLowerCase();\nconst isCloudwatch = hay.includes('cloudwatch') || String(normalized.source ?? '').toLowerCase().includes('cloudwatch') || String(normalized.provider ?? '').toLowerCase().includes('cloudwatch');\nconst hasHint = hay.includes('sulu-updown');\n\nif (isCloudwatch && hasHint && is24x7 && !force && !defaultRequired) {\n  const first = Array.isArray(preview.candidates) ? preview.candidates[0] : null;\n  const wf = first ? (first.workflow_id ?? first.workflowId ?? '') : '';\n  if (String(wf) === 'wf.sulu_service_control') {\n    preview.next_action = 'auto_enqueue';\n    preview.required_confirm = false;\n    preview.rationale = [String(preview.rationale ?? '').trim(), 'forced_auto_enqueue_for_monitoring'].filter(Boolean).join(' | ');\n  }\n}\n\nreturn [{ json: { ...base, preview, llm_output: preview } }];\n"
      },
      "id": "312",
      "name": "Force Auto Enqueue (Monitoring)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2640,
        220
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$env.N8N_DISABLE_PROMPT_OVERRIDE === 'true' || $env.N8N_DISABLE_PROMPT_OVERRIDE === '1'}}",
              "value2": true
            }
          ]
        }
      },
      "id": "27",
      "name": "IF Prompt Override (RAG)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        520,
        -140
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT prompt_text, prompt_version, prompt_hash\nFROM aiops_prompt_history\nWHERE prompt_key = '{{ String($json.prompt_key ?? \"\").replace(/'/g, \"''\") }}'\nORDER BY created_at DESC\nLIMIT 1;"
      },
      "id": "28",
      "name": "Load Prompt History (RAG)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        740,
        -140
      ]
    },
    {
      "parameters": {
        "jsCode": "const base = $node['Apply RAG Route (Input)'].json ?? {};\nconst row = ($json && $json.prompt_text) ? $json : ($json?.[0] ?? {});\nconst promptText = row.prompt_text ?? base.prompt_text;\nconst promptVersion = row.prompt_version ?? base.prompt_version;\nconst promptHash = row.prompt_hash ?? base.prompt_hash;\n\nreturn [{\n  json: {\n    ...base,\n    prompt_text: promptText,\n    prompt_version: promptVersion,\n    prompt_hash: promptHash,\n    prompt_from_history: Boolean(row.prompt_text)\n  }\n}];\n"
      },
      "id": "29",
      "name": "Apply Stored Prompt (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        960,
        -140
      ]
    },
    {
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{$env.N8N_DISABLE_PROMPT_OVERRIDE === 'true' || $env.N8N_DISABLE_PROMPT_OVERRIDE === '1'}}",
              "value2": true
            }
          ]
        }
      },
      "id": "30",
      "name": "IF Prompt Override (Preview)",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1760,
        120
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT prompt_text, prompt_version, prompt_hash\nFROM aiops_prompt_history\nWHERE prompt_key = '{{ String($json.prompt_key ?? \"\").replace(/'/g, \"''\") }}'\nORDER BY created_at DESC\nLIMIT 1;"
      },
      "id": "31",
      "name": "Load Prompt History (Preview)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1980,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const base = $node['Build Preview Prompt (JP)'].json ?? {};\nconst row = ($json && $json.prompt_text) ? $json : ($json?.[0] ?? {});\nconst promptText = row.prompt_text ?? base.prompt_text;\nconst promptVersion = row.prompt_version ?? base.prompt_version;\nconst promptHash = row.prompt_hash ?? base.prompt_hash;\n\nreturn [{\n  json: {\n    ...base,\n    prompt_text: promptText,\n    prompt_version: promptVersion,\n    prompt_hash: promptHash,\n    prompt_from_history: Boolean(row.prompt_text)\n  }\n}];\n"
      },
      "id": "32",
      "name": "Apply Stored Prompt (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2200,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all().map(item => item.json);\nif (!items.length) {\n  return [{ json: { candidate: null, candidates: [] } }];\n}\nconst scored = items.map((item) => ({\n  ...item,\n  rag_score: Number(item.rag_score ?? 0)\n}));\nscored.sort((a, b) => (b.rag_score - a.rag_score));\nreturn [{ json: { candidate: scored[0], candidates: scored } }];\n"
      },
      "id": "33",
      "name": "Select 既知エラーDB Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1400,
        40
      ]
    },
    {
      "parameters": {
        "jsCode": "const items = $input.all().map(item => item.json);\nif (!items.length) {\n  return [{ json: { candidate: null, candidates: [] } }];\n}\nconst scored = items.map((item) => ({\n  ...item,\n  rag_score: Number(item.rag_score ?? 0)\n}));\nscored.sort((a, b) => (b.rag_score - a.rag_score));\nreturn [{ json: { candidate: scored[0], candidates: scored } }];\n"
      },
      "id": "34",
      "name": "Select Problem Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1400,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const workflowContext = this;\nconst input = $json ?? {};\nconst iam = input.iam_context ?? {};\nconst normalizedEvent = input.normalized_event ?? {};\n\nconst source = String(normalizedEvent.source ?? input.source ?? input.reply_target?.source ?? '').trim();\nconst isMonitoringSource = source === 'cloudwatch' || source.startsWith('cloudwatch_');\n\nconst envRealm = String($env.N8N_REALM || $env.N8N_ENV_REALM || '').trim();\nconst realm = iam.realm\n  ?? normalizedEvent.tenant\n  ?? input.reply_target?.realm\n  ?? input.reply_target?.tenant\n  ?? (envRealm || 'default');\n\nconst ttlSecondsRaw = $env.N8N_GITLAB_CACHE_TTL_SECONDS ?? '300';\nconst ttlSeconds = Number.parseInt(String(ttlSecondsRaw), 10);\nconst ttlMs = Number.isFinite(ttlSeconds) ? Math.max(30, ttlSeconds) * 1000 : 300000;\n\nconst cache = (typeof workflowContext.getWorkflowStaticData === 'function') ? workflowContext.getWorkflowStaticData('global') : {};\nconst cacheKey = `gitlab:workflow_catalog:${realm}`;\n\nconst baseUrl = String($env.N8N_GITLAB_API_BASE_URL || $env.GITLAB_API_BASE_URL || '').replace(/\\/$/, '');\nconst token = $env.N8N_GITLAB_TOKEN || $env.GITLAB_TOKEN || '';\nconst ref = $env.N8N_GITLAB_REF || 'main';\n\nconst realmKey = String(realm || '').toUpperCase().replace(/[^A-Z0-9]+/g, '_');\nconst projectPath = $env[`N8N_GITLAB_PROJECT_PATH_${realmKey}`] || $env.N8N_GITLAB_PROJECT_PATH || '';\nconst filePath = $env[`N8N_GITLAB_WORKFLOW_CATALOG_MD_PATH_${realmKey}`] || $env.N8N_GITLAB_WORKFLOW_CATALOG_MD_PATH || '';\n\nfunction splitRow(line) {\n  return line.trim().replace(/^\\|/, '').replace(/\\|$/, '').split('|').map((v) => v.trim());\n}\n\nfunction parseTable(text) {\n  const lines = String(text || '').split(/\\r?\\n/);\n  let headerIdx = -1;\n  for (let i = 0; i < lines.length; i += 1) {\n    const line = lines[i].trim();\n    if (line.startsWith('|') && line.includes('|')) {\n      headerIdx = i;\n      break;\n    }\n  }\n  if (headerIdx < 0 || headerIdx + 1 >= lines.length) return { headers: [], rows: [] };\n  const headers = splitRow(lines[headerIdx]).map((h) => h.toLowerCase());\n  const rows = [];\n  for (let i = headerIdx + 2; i < lines.length; i += 1) {\n    const line = lines[i].trim();\n    if (!line.startsWith('|')) break;\n    if (line.replace(/\\s/g, '').startsWith('|---')) continue;\n    const cols = splitRow(line);\n    if (cols.length === 1 && cols[0] === '') continue;\n    rows.push(cols);\n  }\n  return { headers, rows };\n}\n\nfunction cleanText(value) {\n  if (value === null || value === undefined) return null;\n  const trimmed = String(value).trim();\n  if (!trimmed || trimmed.toLowerCase() === 'null') return null;\n  return trimmed;\n}\n\nfunction parseBool(value, fallback) {\n  const cleaned = cleanText(value);\n  if (cleaned === null) return fallback;\n  const v = cleaned.toLowerCase();\n  if (['true', '1', 'yes', 'y'].includes(v)) return true;\n  if (['false', '0', 'no', 'n'].includes(v)) return false;\n  return fallback;\n}\n\nfunction parseJsonValue(value, fallback) {\n  const cleaned = cleanText(value);\n  if (cleaned === null) return fallback;\n  if (cleaned.startsWith('{') || cleaned.startsWith('[')) {\n    try {\n      return JSON.parse(cleaned);\n    } catch (error) {\n      return fallback;\n    }\n  }\n  return fallback;\n}\n\nfunction parseList(value) {\n  const cleaned = cleanText(value);\n  if (cleaned === null) return [];\n  if (cleaned.startsWith('[')) {\n    const parsed = parseJsonValue(cleaned, []);\n    return Array.isArray(parsed) ? parsed : [];\n  }\n  return cleaned.split(',').map((v) => v.trim()).filter(Boolean);\n}\n\nasync function fetchMarkdown() {\n  if (!baseUrl || !projectPath || !filePath) return null;\n  const projectEncoded = encodeURIComponent(projectPath);\n  const fileEncoded = encodeURIComponent(filePath);\n  const url = `${baseUrl}/projects/${projectEncoded}/repository/files/${fileEncoded}/raw?ref=${encodeURIComponent(ref)}`;\n  const headers = token ? { 'PRIVATE-TOKEN': token } : {};\n  return await workflowContext.helpers.httpRequest({ method: 'GET', url, headers, json: false });\n}\n\nasync function fetchCatalogFallbackRows() {\n  const workflowsToken = String($env.N8N_WORKFLOWS_TOKEN || '').trim();\n  const webhookBaseRaw = $env.N8N_WEBHOOK_BASE_URL || $env.N8N_WEBHOOK_BASE_URL || ($env.N8N_PUBLIC_API_BASE_URL ? (String($env.N8N_PUBLIC_API_BASE_URL).replace(/\\/$/, '') + '/webhook') : '');\n  const webhookBase = String(webhookBaseRaw || '').replace(/\\/+$/, '');\n  if (!workflowsToken || !webhookBase) return null;\n\n  try {\n    const response = await workflowContext.helpers.httpRequest({\n      method: 'GET',\n      url: `${webhookBase}/catalog/workflows/list`,\n      qs: { limit: 250 },\n      json: true,\n      headers: { Authorization: `Bearer ${workflowsToken}` },\n      timeout: 10000\n    });\n\n    const ok = Boolean(response?.ok);\n    const data = response?.data;\n    if (!ok || !Array.isArray(data)) return null;\n\n    return data.map((item) => {\n      const catalog = item?.aiops_catalog ?? item?.meta?.aiops_catalog ?? item?.settings?.aiops_catalog ?? null;\n      const c = catalog && typeof catalog === 'object' ? catalog : {};\n      return {\n        workflow_id: cleanText(c.workflow_id) ?? cleanText(item?.id),\n        workflow_name: cleanText(item?.name) ?? cleanText(c.workflow_id),\n        workflow_class: cleanText(c.workflow_class),\n        summary: cleanText(c.summary) ?? cleanText(item?.description) ?? '',\n        realm: cleanText(c.realm) ?? realm,\n        platform: cleanText(c.platform),\n        required_roles: JSON.stringify(Array.isArray(c.required_roles) ? c.required_roles : []),\n        required_groups: JSON.stringify(Array.isArray(c.required_groups) ? c.required_groups : []),\n        required_users: JSON.stringify(Array.isArray(c.required_users) ? c.required_users : []),\n        risk_level: cleanText(c.risk_level) ?? 'medium',\n        impact_scope: cleanText(c.impact_scope) ?? 'service',\n        available: (c.available === undefined ? true : c.available),\n        available_from_monitoring: (c.available_from_monitoring === undefined ? true : c.available_from_monitoring),\n        aiops_approved: (c.aiops_approved === undefined ? true : c.aiops_approved),\n        params: JSON.stringify(c.params ?? {}),\n        run_window: cleanText(c.run_window),\n        approval_contact: cleanText(c.approval_contact)\n      };\n    });\n  } catch (error) {\n    return null;\n  }\n}\n\nconst cached = cache?.[cacheKey] || null;\nconst cacheFresh = cached && cached.fetched_at && (Date.now() - cached.fetched_at) < ttlMs;\nlet rows = cacheFresh ? cached.rows : null;\nlet usedCache = cacheFresh;\nlet fetchError = null;\n\nif (!rows) {\n  try {\n    const markdown = await fetchMarkdown();\n    const table = parseTable(markdown);\n    if (!table.headers.length) throw new Error('table_not_found');\n    rows = table.rows.map((cols) => {\n      const entry = {};\n      table.headers.forEach((header, idx) => {\n        entry[header] = cols[idx] ?? null;\n      });\n      return entry;\n    });\n    cache[cacheKey] = { fetched_at: Date.now(), rows };\n  } catch (error) {\n    fetchError = error?.message ? String(error.message) : String(error);\n    rows = cached?.rows || null;\n    usedCache = Boolean(cached?.rows);\n\n    if (!usedCache) {\n      const fallbackRows = await fetchCatalogFallbackRows();\n      if (fallbackRows && Array.isArray(fallbackRows) && fallbackRows.length) {\n        rows = fallbackRows;\n        fetchError = null;\n      }\n    }\n\n    rows = rows || [];\n  }\n}\n\nconst catalog = (rows || []).map((entry) => {\n  const workflowName = cleanText(entry.workflow_name) ?? cleanText(entry.workflow);\n  const workflowId = cleanText(entry.workflow_id);\n  const requiredRoles = parseJsonValue(entry.required_roles, null) || parseList(entry.required_roles);\n  const requiredGroups = parseJsonValue(entry.required_groups, null) || parseList(entry.required_groups);\n  const requiredUsers = parseJsonValue(entry.required_users, null) || parseList(entry.required_users);\n  const params = parseJsonValue(entry.params, {}) || {};\n\n  const aiopsApproved = parseBool(entry.aiops_approved, true);\n  const available = parseBool(entry.available, true);\n  const availableFromMonitoring = parseBool(entry.available_from_monitoring, true);\n\n  const catalogEntry = {\n    workflow_id: workflowId,\n    workflow_name: workflowName,\n    workflow_class: cleanText(entry.workflow_class),\n    summary: cleanText(entry.summary) ?? '',\n    realm: cleanText(entry.realm) ?? realm,\n    platform: cleanText(entry.platform),\n    required_roles: requiredRoles,\n    required_groups: requiredGroups,\n    required_users: requiredUsers,\n    risk_level: String(cleanText(entry.risk_level) ?? 'medium').toLowerCase(),\n    impact_scope: String(cleanText(entry.impact_scope) ?? 'service').toLowerCase(),\n    available,\n    available_from_monitoring: availableFromMonitoring,\n    aiops_approved: aiopsApproved,\n    params,\n    run_window: cleanText(entry.run_window),\n    approval_contact: cleanText(entry.approval_contact)\n  };\n\n  return {\n    id: workflowId || null,\n    name: workflowName || workflowId || null,\n    description: catalogEntry.summary || '',\n    aiops_catalog: catalogEntry,\n    settings: { aiops_catalog: catalogEntry },\n    meta: { aiops_catalog: catalogEntry }\n  };\n}).filter((item) => {\n  const c = item?.aiops_catalog ?? null;\n  if (!c) return false;\n  if (!c.aiops_approved) return false;\n  if (!c.available) return false;\n  if (isMonitoringSource && !c.available_from_monitoring) return false;\n  return true;\n});\n\nconst meta = {\n  realm,\n  project_path: projectPath || null,\n  file_path: filePath || null,\n  ref,\n  cached: usedCache,\n  cache_ttl_seconds: Math.floor(ttlMs / 1000)\n};\nif (fetchError) meta.error = fetchError;\n\nreturn [{ json: { ...input, catalog, catalog_meta: meta } }];\n"
      },
      "id": "35",
      "name": "Fetch Catalog (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1640,
        120
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT feedback_id, job_id, resolved, smile_score, comment, created_at\nFROM aiops_job_feedback\nWHERE context_id = NULLIF(NULLIF('{{$json.context_id}}',''), 'undefined')::uuid\nORDER BY created_at DESC\nLIMIT {{$json.policy_context?.limits?.orchestrator?.max_recent_feedback ?? 5}};"
      },
      "id": "36",
      "name": "Load Feedback (Preview)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1800,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const base = $node['Fetch Catalog (Preview)'].json ?? {};\nconst rows = $input.all().map((item) => item.json);\nreturn [{ json: { ...base, feedback: rows } }];\n"
      },
      "id": "37",
      "name": "Attach Feedback (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2000,
        120
      ]
    },
    {
      "parameters": {
        "operation": "executeQuery",
        "query": "SELECT approval_history_id, approval_id, decision, actor, job_plan, created_at\nFROM aiops_approval_history\nWHERE context_id = NULLIF(NULLIF('{{$json.context_id}}',''), 'undefined')::uuid\nORDER BY created_at DESC\nLIMIT {{$json.policy_context?.limits?.orchestrator?.max_recent_approvals ?? 5}};"
      },
      "id": "53",
      "name": "Load Approval History (Preview)",
      "type": "n8n-nodes-base.postgres",
      "typeVersion": 2,
      "position": [
        1160,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const base = $node['Attach Feedback (Preview)'].json ?? $json ?? {};\nconst rows = $input.all().map((item) => item.json);\nreturn [{ json: { ...base, approval_history: rows } }];\n"
      },
      "id": "54",
      "name": "Attach Approval History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1360,
        520
      ]
    },
    {
      "parameters": {
        "conditions": {
          "string": [
            {
              "value1": "={{$json.rag_mode}}",
              "value2": "none",
              "operation": "notEqual"
            }
          ]
        }
      },
      "id": "200",
      "name": "IF RAG Enabled",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        980,
        120
      ]
    },
    {
      "id": "210",
      "name": "IF GitLab Management Issues Mode",
      "type": "n8n-nodes-base.if",
      "typeVersion": 2,
      "position": [
        1040,
        300
      ],
      "parameters": {
        "conditions": {
          "boolean": [
            {
              "value1": "={{ ['gitlab_management_docs','gitlab_management_issues'].includes($json.rag_mode) }}",
              "value2": true
            }
          ]
        }
      }
    },
    {
      "id": "211",
      "name": "Query GitLab Management Issues Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1240,
        280
      ],
      "parameters": {
        "jsCode": "const workflowContext = this;\n\nconst base = $json ?? {};\nconst ragRoute = base.rag_route ?? {};\nconst ragFilters = base.rag_filters ?? {};\n\nconst query = String(ragRoute.query ?? base.rag_query ?? '').trim();\nconst topK = Math.max(1, Math.floor(Number(base.rag_top_k ?? 5) || 5));\n\nconst iam = base.iam_context ?? {};\n\nfunction normalizeString(v) {\n  return String(v ?? '').trim();\n}\n\nfunction extractGroupNames(iamContext) {\n  const out = [];\n\n  const pushAny = (value) => {\n    if (!value) return;\n    if (Array.isArray(value)) {\n      for (const entry of value) pushAny(entry);\n      return;\n    }\n    if (typeof value === 'string') {\n      value\n        .split(',')\n        .map((s) => s.trim())\n        .filter(Boolean)\n        .forEach((s) => out.push(s));\n      return;\n    }\n    if (typeof value === 'object') {\n      const keys = [\n        'groups',\n        'group_names',\n        'groupNames',\n        'keycloak_groups',\n        'kc_groups',\n        'user_groups',\n        'userGroupNames',\n        'roles',\n        'role_names'\n      ];\n      for (const key of keys) {\n        if (key in value) pushAny(value[key]);\n      }\n      if ('user' in value && value.user && typeof value.user === 'object') {\n        pushAny(value.user.groups);\n        pushAny(value.user.group_names);\n        pushAny(value.user.groupNames);\n      }\n    }\n  };\n\n  pushAny(iamContext);\n\n  const uniq = [];\n  const seen = new Set();\n  for (const raw of out) {\n    const cleaned = normalizeString(raw);\n    if (!cleaned) continue;\n    if (seen.has(cleaned)) continue;\n    seen.add(cleaned);\n    uniq.push(cleaned);\n  }\n  return uniq;\n}\n\nconst actorGroups = extractGroupNames(iam);\n\n// Group -> management_domain mapping (Keycloak groups)\nconst domainByGroup = {\n  'Technical Management Group': 'technical_management',\n  'Service Management Group': 'service_management',\n  'General Management Group': 'general_management'\n};\n\nconst allDomains = ['general_management', 'service_management', 'technical_management'];\nconst isAdmin = actorGroups.includes('Admins');\n\nconst allowedByGroup = new Set();\nif (isAdmin) {\n  for (const d of allDomains) allowedByGroup.add(d);\n} else {\n  for (const g of actorGroups) {\n    const d = domainByGroup[g];\n    if (d) allowedByGroup.add(d);\n  }\n}\n\nconst requestedDomainsRaw = Array.isArray(ragFilters.management_domains) ? ragFilters.management_domains : [];\nconst requestedDomains = requestedDomainsRaw.map((v) => String(v ?? '').trim().toLowerCase()).filter(Boolean);\n\nconst effectiveDomains = (requestedDomains.length > 0)\n  ? requestedDomains.filter((d) => allowedByGroup.has(d))\n  : Array.from(allowedByGroup);\n\nif (!query) {\n  return [{ json: { __rag_empty: true, rag_error: 'empty_query', actor_groups: actorGroups, allowed_domains: effectiveDomains } }];\n}\n\nif (effectiveDomains.length === 0) {\n  return [{ json: { __rag_empty: true, rag_error: 'rag_access_denied', actor_groups: actorGroups, allowed_domains: [] } }];\n}\n\nfunction normalizeUrlBase(url) {\n  return String(url ?? '').replace(/\\/$/, '');\n}\n\n// Embeddings (must match the indexer model/dimension)\nconst embeddingApiBase = normalizeUrlBase($env.N8N_EMBEDDING_API_BASE_URL || $env.OPENAI_BASE_URL || 'https://api.openai.com/v1');\nconst embeddingApiKey = String($env.N8N_EMBEDDING_API_KEY || $env.OPENAI_API_KEY || $env.OPENAI_MODEL_API_KEY || '').trim();\nconst embeddingModel = String($env.N8N_EMBEDDING_MODEL || $env.OPENAI_EMBEDDING_MODEL || 'text-embedding-3-small').trim();\n\nif (!embeddingApiKey) {\n  return [{ json: { __rag_empty: true, rag_error: 'missing_embedding_api_key', actor_groups: actorGroups, allowed_domains: effectiveDomains } }];\n}\n\nlet embedding = null;\ntry {\n  const resp = await workflowContext.helpers.httpRequest({\n    method: 'POST',\n    url: `${embeddingApiBase}/embeddings`,\n    json: true,\n    headers: {\n      Authorization: `Bearer ${embeddingApiKey}`,\n      'Content-Type': 'application/json'\n    },\n    body: {\n      model: embeddingModel,\n      input: query\n    },\n    timeout: 120000\n  });\n  const data = Array.isArray(resp?.data) ? resp.data : [];\n  embedding = data[0]?.embedding ?? null;\n} catch (error) {\n  const msg = error?.message ? String(error.message) : String(error);\n  return [{ json: { __rag_empty: true, rag_error: 'embedding_failed', rag_error_message: msg, actor_groups: actorGroups, allowed_domains: effectiveDomains } }];\n}\n\nif (!Array.isArray(embedding) || embedding.length === 0) {\n  return [{ json: { __rag_empty: true, rag_error: 'embedding_missing', actor_groups: actorGroups, allowed_domains: effectiveDomains } }];\n}\n\n// Qdrant (n8n task sidecar)\nconst qdrantBase = normalizeUrlBase($env.QDRANT_URL || '');\nif (!qdrantBase) {\n  return [{ json: { __rag_empty: true, rag_error: 'missing_qdrant_url', actor_groups: actorGroups, allowed_domains: effectiveDomains } }];\n}\n\n// Collection alias mapping (defaults match docs/itsm/README.md)\nconst defaultAliasMap = {\n  general_management: 'gitlab_efs_general_management',\n  service_management: 'gitlab_efs_service_management',\n  technical_management: 'gitlab_efs_technical_management'\n};\n\nlet aliasMap = { ...defaultAliasMap };\ntry {\n  const raw = String($env.N8N_QDRANT_COLLECTION_ALIAS_MAP_JSON || '').trim();\n  if (raw) {\n    const parsed = JSON.parse(raw);\n    if (parsed && typeof parsed === 'object' && !Array.isArray(parsed)) {\n      for (const [k, v] of Object.entries(parsed)) {\n        if (typeof k === 'string' && typeof v === 'string' && k.trim() && v.trim()) {\n          aliasMap[k.trim()] = v.trim();\n        }\n      }\n    }\n  }\n} catch (error) {\n  // ignore invalid override\n}\n\nconst fallbackAlias = String($env.N8N_QDRANT_COLLECTION_ALIAS || 'gitlab_efs').trim() || 'gitlab_efs';\n\nconst gitlabWebBase = normalizeUrlBase($env.N8N_GITLAB_WEB_BASE_URL || $env.GITLAB_WEB_BASE_URL || '');\n\nfunction guessSourceUrl(meta) {\n  if (!gitlabWebBase || !meta) return null;\n  const repo = String(meta.repo ?? '').replace(/\\.git$/, '');\n  const path = String(meta.path ?? '').replace(/^\\//, '');\n  const head = String(meta.head ?? '').trim() || null;\n  const isWiki = Boolean(meta.is_wiki);\n  if (!repo) return null;\n\n  if (isWiki) {\n    const projectPath = repo.replace(/\\.wiki$/, '');\n    const page = path.replace(/\\.md$/i, '');\n    if (!projectPath || !page) return null;\n    return `${gitlabWebBase}/${projectPath}/-/wikis/${encodeURI(page)}`;\n  }\n\n  if (!path) return null;\n  const ref = head || 'HEAD';\n  return `${gitlabWebBase}/${repo}/-/blob/${encodeURI(ref)}/${encodeURI(path)}`;\n}\n\nconst hits = [];\n\nfor (const domain of effectiveDomains) {\n  const alias = aliasMap[domain] || fallbackAlias;\n\n  const body = {\n    vector: embedding,\n    limit: topK,\n    with_payload: true,\n    with_vector: false\n  };\n\n  // If using a shared collection, filter by domain to avoid leakage.\n  if (!aliasMap[domain] && effectiveDomains.length > 1) {\n    body.filter = {\n      must: [\n        {\n          key: 'metadata.management_domain',\n          match: { value: domain }\n        }\n      ]\n    };\n  }\n\n  let resp;\n  try {\n    resp = await workflowContext.helpers.httpRequest({\n      method: 'POST',\n      url: `${qdrantBase}/collections/${encodeURIComponent(alias)}/points/search`,\n      json: true,\n      headers: { 'Content-Type': 'application/json' },\n      body,\n      timeout: 120000\n    });\n  } catch (error) {\n    // Keep going; other domains might still work.\n    continue;\n  }\n\n  const results = Array.isArray(resp?.result) ? resp.result : [];\n  for (const hit of results) {\n    const payload = hit?.payload ?? {};\n    const content = payload?.content ?? null;\n    const metadata = payload?.metadata ?? null;\n\n    hits.push({\n      rag_score: typeof hit?.score === 'number' ? hit.score : 0,\n      content,\n      metadata,\n      source_url: guessSourceUrl(metadata),\n      qdrant_collection_alias: alias,\n      management_domain: String(metadata?.management_domain ?? domain),\n      point_id: hit?.id ?? null,\n      actor_groups: actorGroups,\n      allowed_domains: effectiveDomains\n    });\n  }\n}\n\nif (hits.length === 0) {\n  return [{ json: { __rag_empty: true, rag_error: 'no_results', actor_groups: actorGroups, allowed_domains: effectiveDomains } }];\n}\n\nreturn hits.map((row) => ({ json: row }));\n"
      }
    },
    {
      "id": "212",
      "name": "Select GitLab Management Issues Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1440,
        280
      ],
      "parameters": {
        "jsCode": "const items = $input.all().map(item => item.json).filter((item) => !(item && item.__rag_empty));\nif (!items.length) {\n  return [{ json: { candidate: null, candidates: [] } }];\n}\nconst scored = items.map((item) => ({\n  ...item,\n  rag_score: Number(item.rag_score ?? 0)\n}));\nscored.sort((a, b) => (b.rag_score - a.rag_score));\nreturn [{ json: { candidate: scored[0], candidates: scored } }];\n"
      }
    },
    {
      "id": "213",
      "name": "Set GitLab Management Issues Candidate Context",
      "type": "n8n-nodes-base.set",
      "typeVersion": 1,
      "position": [
        1520,
        280
      ],
      "parameters": {
        "values": {
          "boolean": [],
          "number": [],
          "string": [
            {
              "name": "context_id",
              "value": "={{ $node['Enrich RAG Route'].json.context_id }}"
            },
            {
              "name": "actor",
              "value": "={{ $node['Enrich RAG Route'].json.actor }}"
            },
            {
              "name": "normalized_event",
              "value": "={{ $node['Enrich RAG Route'].json.normalized_event }}"
            },
            {
              "name": "iam_context",
              "value": "={{ $node['Enrich RAG Route'].json.iam_context }}"
            },
            {
              "name": "policy_context",
              "value": "={{ $node['Enrich RAG Route'].json.policy_context }}"
            },
            {
              "name": "rag_route",
              "value": "={{ $node['Enrich RAG Route'].json.rag_route }}"
            },
            {
              "name": "rag_mode",
              "value": "={{ $node['Enrich RAG Route'].json.rag_mode }}"
            },
            {
              "name": "rag_filters",
              "value": "={{ $node['Enrich RAG Route'].json.rag_filters }}"
            },
            {
              "name": "candidate_source",
              "value": "gitlab_management_docs"
            },
            {
              "name": "candidate",
              "value": "={{ $node['Select GitLab Management Issues Candidate'].json.candidate }}"
            },
            {
              "name": "candidate_list",
              "value": "={{ $node['Select GitLab Management Issues Candidate'].json.candidates }}"
            }
          ],
          "collection": []
        },
        "options": {}
      }
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Webhook (jobs.Preview)',\n  target: 'Apply RAG Route (Input)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "214",
      "name": "Debug Log After: Webhook (jobs.Preview) -> Apply RAG Route (Input)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Webhook (jobs.Preview)',\n  target: 'Apply RAG Route (Input)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "215",
      "name": "Debug Log Before: Apply RAG Route (Input) <- Webhook (jobs.Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        380,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Build Job Plan + Token',\n  target: 'Save Pending Approval',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "216",
      "name": "Debug Log After: Build Job Plan + Token -> Save Pending Approval",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        660,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Build Job Plan + Token',\n  target: 'Save Pending Approval',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "217",
      "name": "Debug Log Before: Save Pending Approval <- Build Job Plan + Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        620,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Save Pending Approval',\n  target: 'Return Preview',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "218",
      "name": "Debug Log After: Save Pending Approval -> Return Preview",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Save Pending Approval',\n  target: 'Return Preview',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "219",
      "name": "Debug Log Before: Return Preview <- Save Pending Approval",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        860,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Webhook (jobs.enqueue)',\n  target: 'Verify Token (enqueue)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "220",
      "name": "Debug Log After: Webhook (jobs.enqueue) -> Verify Token (enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        400,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Webhook (jobs.enqueue)',\n  target: 'Verify Token (enqueue)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "221",
      "name": "Debug Log Before: Verify Token (enqueue) <- Webhook (jobs.enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        380,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Verify Token (enqueue)',\n  target: 'Load Context (enqueue)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "222",
      "name": "Debug Log After: Verify Token (enqueue) -> Load Context (enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        660,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Verify Token (enqueue)',\n  target: 'Load Context (enqueue)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "223",
      "name": "Debug Log Before: Load Context (enqueue) <- Verify Token (enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        580,
        620
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Load Context (enqueue)',\n  target: 'Check Workflow Availability (enqueue)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "224",
      "name": "Debug Log After: Load Context (enqueue) -> Check Workflow Availability (enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        860,
        620
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Load Context (enqueue)',\n  target: 'Check Workflow Availability (enqueue)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "225",
      "name": "Debug Log Before: Check Workflow Availability (enqueue) <- Load Context (enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        820,
        620
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Check Workflow Availability (enqueue)',\n  target: 'Consume Approval',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "226",
      "name": "Debug Log After: Check Workflow Availability (enqueue) -> Consume Approval",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        620
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Check Workflow Availability (enqueue)',\n  target: 'Consume Approval',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "227",
      "name": "Debug Log Before: Consume Approval <- Check Workflow Availability (enqueue)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        620,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Consume Approval',\n  target: 'Ensure Approval Consumed',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "228",
      "name": "Debug Log After: Consume Approval -> Ensure Approval Consumed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Consume Approval',\n  target: 'Ensure Approval Consumed',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "229",
      "name": "Debug Log Before: Ensure Approval Consumed <- Consume Approval",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        760,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Enrich RAG Route',\n  target: 'IF RAG Enabled',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "230",
      "name": "Debug Log After: Enrich RAG Route -> IF RAG Enabled",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        980,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Enrich RAG Route',\n  target: 'IF RAG Enabled',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "231",
      "name": "Debug Log Before: IF RAG Enabled <- Enrich RAG Route",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        840,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF 既知エラーDB Mode',\n  target: 'Query 既知エラーDB Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "232",
      "name": "Debug Log After: IF 既知エラーDB Mode -> Query 既知エラーDB Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1180,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF 既知エラーDB Mode',\n  target: 'Query 既知エラーDB Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "233",
      "name": "Debug Log Before: Query 既知エラーDB Candidate <- IF 既知エラーDB Mode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF 既知エラーDB Mode',\n  target: 'IF GitLab Management Issues Mode',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "234",
      "name": "Debug Log After: IF 既知エラーDB Mode -> IF GitLab Management Issues Mode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1180,
        180
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF 既知エラーDB Mode',\n  target: 'IF GitLab Management Issues Mode',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "235",
      "name": "Debug Log Before: IF GitLab Management Issues Mode <- IF 既知エラーDB Mode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Query 既知エラーDB Candidate',\n  target: 'Select 既知エラーDB Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "236",
      "name": "Debug Log After: Query 既知エラーDB Candidate -> Select 既知エラーDB Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1380,
        100
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Query 既知エラーDB Candidate',\n  target: 'Select 既知エラーDB Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "237",
      "name": "Debug Log Before: Select 既知エラーDB Candidate <- Query 既知エラーDB Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1260,
        40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Set 既知エラーDB Candidate Context',\n  target: 'Fetch Catalog (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "238",
      "name": "Debug Log After: Set 既知エラーDB Candidate Context -> Fetch Catalog (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1660,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Set 既知エラーDB Candidate Context',\n  target: 'Fetch Catalog (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "239",
      "name": "Debug Log Before: Fetch Catalog (Preview) <- Set 既知エラーDB Candidate Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Query Problem Candidate',\n  target: 'Select Problem Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "240",
      "name": "Debug Log After: Query Problem Candidate -> Select Problem Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1380,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Query Problem Candidate',\n  target: 'Select Problem Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "241",
      "name": "Debug Log Before: Select Problem Candidate <- Query Problem Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1260,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Set Problem Candidate Context',\n  target: 'Fetch Catalog (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "242",
      "name": "Debug Log After: Set Problem Candidate Context -> Fetch Catalog (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1660,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Set Problem Candidate Context',\n  target: 'Fetch Catalog (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "243",
      "name": "Debug Log Before: Fetch Catalog (Preview) <- Set Problem Candidate Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        180
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Ensure Approval Consumed',\n  target: 'Enqueue Job Engine',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "244",
      "name": "Debug Log After: Ensure Approval Consumed -> Enqueue Job Engine",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Ensure Approval Consumed',\n  target: 'Enqueue Job Engine',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "245",
      "name": "Debug Log Before: Enqueue Job Engine <- Ensure Approval Consumed",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        980,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Enqueue Job Engine',\n  target: 'Return Enqueue Ack',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "246",
      "name": "Debug Log After: Enqueue Job Engine -> Return Enqueue Ack",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1260,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Enqueue Job Engine',\n  target: 'Return Enqueue Ack',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "247",
      "name": "Debug Log Before: Return Enqueue Ack <- Enqueue Job Engine",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        860,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Record Prompt History (RAG)',\n  target: 'OpenAI RAG Router',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "248",
      "name": "Debug Log After: Record Prompt History (RAG) -> OpenAI RAG Router",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Record Prompt History (RAG)',\n  target: 'OpenAI RAG Router',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "249",
      "name": "Debug Log Before: OpenAI RAG Router <- Record Prompt History (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        820,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'OpenAI RAG Router',\n  target: 'Parse RAG Response',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "250",
      "name": "Debug Log After: OpenAI RAG Router -> Parse RAG Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'OpenAI RAG Router',\n  target: 'Parse RAG Response',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "251",
      "name": "Debug Log Before: Parse RAG Response <- OpenAI RAG Router",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1040,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Parse RAG Response',\n  target: 'IF RAG Route OK',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "252",
      "name": "Debug Log After: Parse RAG Response -> IF RAG Route OK",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1320,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Parse RAG Response',\n  target: 'IF RAG Route OK',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "253",
      "name": "Debug Log Before: IF RAG Route OK <- Parse RAG Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1260,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF RAG Route OK',\n  target: 'Enrich RAG Route',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "254",
      "name": "Debug Log After: IF RAG Route OK -> Enrich RAG Route",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1540,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF RAG Route OK',\n  target: 'Enrich RAG Route',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "255",
      "name": "Debug Log Before: Enrich RAG Route <- IF RAG Route OK",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF RAG Route OK',\n  target: 'RAG Router (Basic)',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "256",
      "name": "Debug Log After: IF RAG Route OK -> RAG Router (Basic)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1540,
        20
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF RAG Route OK',\n  target: 'RAG Router (Basic)',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "257",
      "name": "Debug Log Before: RAG Router (Basic) <- IF RAG Route OK",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        380,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'RAG Router (Basic)',\n  target: 'Enrich RAG Route',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "258",
      "name": "Debug Log After: RAG Router (Basic) -> Enrich RAG Route",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        660,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'RAG Router (Basic)',\n  target: 'Enrich RAG Route',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "259",
      "name": "Debug Log Before: Enrich RAG Route <- RAG Router (Basic)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        180
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Build Preview Prompt (JP)',\n  target: 'IF Prompt Override (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "260",
      "name": "Debug Log After: Build Preview Prompt (JP) -> IF Prompt Override (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1900,
        220
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Build Preview Prompt (JP)',\n  target: 'IF Prompt Override (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "261",
      "name": "Debug Log Before: IF Prompt Override (Preview) <- Build Preview Prompt (JP)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1620,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Record Prompt History (Preview)',\n  target: 'OpenAI Jobs Preview',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "262",
      "name": "Debug Log After: Record Prompt History (Preview) -> OpenAI Jobs Preview",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2120,
        220
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Record Prompt History (Preview)',\n  target: 'OpenAI Jobs Preview',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "263",
      "name": "Debug Log Before: OpenAI Jobs Preview <- Record Prompt History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2060,
        220
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'OpenAI Jobs Preview',\n  target: 'Parse Preview Response',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "264",
      "name": "Debug Log After: OpenAI Jobs Preview -> Parse Preview Response",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2340,
        220
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'OpenAI Jobs Preview',\n  target: 'Parse Preview Response',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "265",
      "name": "Debug Log Before: Parse Preview Response <- OpenAI Jobs Preview",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2280,
        220
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF Prompt Override (RAG)',\n  target: 'Load Prompt History (RAG)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "266",
      "name": "Debug Log After: IF Prompt Override (RAG) -> Load Prompt History (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        660,
        -140
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF Prompt Override (RAG)',\n  target: 'Load Prompt History (RAG)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "267",
      "name": "Debug Log Before: Load Prompt History (RAG) <- IF Prompt Override (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        -140
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF Prompt Override (RAG)',\n  target: 'Record Prompt History (RAG)',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "268",
      "name": "Debug Log After: IF Prompt Override (RAG) -> Record Prompt History (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        660,
        -80
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF Prompt Override (RAG)',\n  target: 'Record Prompt History (RAG)',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "269",
      "name": "Debug Log Before: Record Prompt History (RAG) <- IF Prompt Override (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        600,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Load Prompt History (RAG)',\n  target: 'Apply Stored Prompt (RAG)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "270",
      "name": "Debug Log After: Load Prompt History (RAG) -> Apply Stored Prompt (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        880,
        -140
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Load Prompt History (RAG)',\n  target: 'Apply Stored Prompt (RAG)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "271",
      "name": "Debug Log Before: Apply Stored Prompt (RAG) <- Load Prompt History (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        820,
        -140
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Apply Stored Prompt (RAG)',\n  target: 'OpenAI RAG Router',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "272",
      "name": "Debug Log After: Apply Stored Prompt (RAG) -> OpenAI RAG Router",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        -140
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Apply Stored Prompt (RAG)',\n  target: 'OpenAI RAG Router',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "273",
      "name": "Debug Log Before: OpenAI RAG Router <- Apply Stored Prompt (RAG)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        820,
        20
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF Prompt Override (Preview)',\n  target: 'Load Prompt History (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "274",
      "name": "Debug Log After: IF Prompt Override (Preview) -> Load Prompt History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1900,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF Prompt Override (Preview)',\n  target: 'Load Prompt History (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "275",
      "name": "Debug Log Before: Load Prompt History (Preview) <- IF Prompt Override (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1840,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF Prompt Override (Preview)',\n  target: 'Record Prompt History (Preview)',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "276",
      "name": "Debug Log After: IF Prompt Override (Preview) -> Record Prompt History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1900,
        180
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF Prompt Override (Preview)',\n  target: 'Record Prompt History (Preview)',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "277",
      "name": "Debug Log Before: Record Prompt History (Preview) <- IF Prompt Override (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1840,
        220
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Load Prompt History (Preview)',\n  target: 'Apply Stored Prompt (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "278",
      "name": "Debug Log After: Load Prompt History (Preview) -> Apply Stored Prompt (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2120,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Load Prompt History (Preview)',\n  target: 'Apply Stored Prompt (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "279",
      "name": "Debug Log Before: Apply Stored Prompt (Preview) <- Load Prompt History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2060,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Apply Stored Prompt (Preview)',\n  target: 'OpenAI Jobs Preview',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "280",
      "name": "Debug Log After: Apply Stored Prompt (Preview) -> OpenAI Jobs Preview",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2340,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Apply Stored Prompt (Preview)',\n  target: 'OpenAI Jobs Preview',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "281",
      "name": "Debug Log Before: OpenAI Jobs Preview <- Apply Stored Prompt (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2060,
        280
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Select 既知エラーDB Candidate',\n  target: 'Set 既知エラーDB Candidate Context',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "282",
      "name": "Debug Log After: Select 既知エラーDB Candidate -> Set 既知エラーDB Candidate Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1540,
        40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Select 既知エラーDB Candidate',\n  target: 'Set 既知エラーDB Candidate Context',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "283",
      "name": "Debug Log Before: Set 既知エラーDB Candidate Context <- Select 既知エラーDB Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1380,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Select Problem Candidate',\n  target: 'Set Problem Candidate Context',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "284",
      "name": "Debug Log After: Select Problem Candidate -> Set Problem Candidate Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1540,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Select Problem Candidate',\n  target: 'Set Problem Candidate Context',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "285",
      "name": "Debug Log Before: Set Problem Candidate Context <- Select Problem Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1380,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Fetch Catalog (Preview)',\n  target: 'Load Feedback (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "286",
      "name": "Debug Log After: Fetch Catalog (Preview) -> Load Feedback (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1780,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Fetch Catalog (Preview)',\n  target: 'Load Feedback (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "287",
      "name": "Debug Log Before: Load Feedback (Preview) <- Fetch Catalog (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1660,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Load Feedback (Preview)',\n  target: 'Attach Feedback (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "288",
      "name": "Debug Log After: Load Feedback (Preview) -> Attach Feedback (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1940,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Load Feedback (Preview)',\n  target: 'Attach Feedback (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "289",
      "name": "Debug Log Before: Attach Feedback (Preview) <- Load Feedback (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1860,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Attach Feedback (Preview)',\n  target: 'Load Approval History (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "290",
      "name": "Debug Log After: Attach Feedback (Preview) -> Load Approval History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        2140,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Attach Feedback (Preview)',\n  target: 'Load Approval History (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "291",
      "name": "Debug Log Before: Load Approval History (Preview) <- Attach Feedback (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1020,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Load Approval History (Preview)',\n  target: 'Attach Approval History (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "292",
      "name": "Debug Log After: Load Approval History (Preview) -> Attach Approval History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Load Approval History (Preview)',\n  target: 'Attach Approval History (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "293",
      "name": "Debug Log Before: Attach Approval History (Preview) <- Load Approval History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1220,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Attach Approval History (Preview)',\n  target: 'Build Job Plan + Token',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "294",
      "name": "Debug Log After: Attach Approval History (Preview) -> Build Job Plan + Token",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        520
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Attach Approval History (Preview)',\n  target: 'Build Job Plan + Token',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "295",
      "name": "Debug Log Before: Build Job Plan + Token <- Attach Approval History (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        380,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Apply RAG Route (Input)',\n  target: 'Enrich RAG Route',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "296",
      "name": "Debug Log After: Apply RAG Route (Input) -> Enrich RAG Route",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        660,
        -40
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Apply RAG Route (Input)',\n  target: 'Enrich RAG Route',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "297",
      "name": "Debug Log Before: Enrich RAG Route <- Apply RAG Route (Input)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        700,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF RAG Enabled',\n  target: 'IF 既知エラーDB Mode',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "298",
      "name": "Debug Log After: IF RAG Enabled -> IF 既知エラーDB Mode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF RAG Enabled',\n  target: 'IF 既知エラーDB Mode',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "299",
      "name": "Debug Log Before: IF 既知エラーDB Mode <- IF RAG Enabled",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        900,
        120
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF RAG Enabled',\n  target: 'Fetch Catalog (Preview)',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "300",
      "name": "Debug Log After: IF RAG Enabled -> Fetch Catalog (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1120,
        180
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF RAG Enabled',\n  target: 'Fetch Catalog (Preview)',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "301",
      "name": "Debug Log Before: Fetch Catalog (Preview) <- IF RAG Enabled",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        240
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF GitLab Management Issues Mode',\n  target: 'Query GitLab Management Issues Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "302",
      "name": "Debug Log After: IF GitLab Management Issues Mode -> Query GitLab Management Issues Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1180,
        300
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF GitLab Management Issues Mode',\n  target: 'Query GitLab Management Issues Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "303",
      "name": "Debug Log Before: Query GitLab Management Issues Candidate <- IF GitLab Management Issues Mode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        280
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'IF GitLab Management Issues Mode',\n  target: 'Query Problem Candidate',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "304",
      "name": "Debug Log After: IF GitLab Management Issues Mode -> Query Problem Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1180,
        360
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'IF GitLab Management Issues Mode',\n  target: 'Query Problem Candidate',\n  output_index: 1,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "305",
      "name": "Debug Log Before: Query Problem Candidate <- IF GitLab Management Issues Mode",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1100,
        320
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Query GitLab Management Issues Candidate',\n  target: 'Select GitLab Management Issues Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "306",
      "name": "Debug Log After: Query GitLab Management Issues Candidate -> Select GitLab Management Issues Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1380,
        280
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Query GitLab Management Issues Candidate',\n  target: 'Select GitLab Management Issues Candidate',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "307",
      "name": "Debug Log Before: Select GitLab Management Issues Candidate <- Query GitLab Management Issues Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1300,
        280
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Select GitLab Management Issues Candidate',\n  target: 'Set GitLab Management Issues Candidate Context',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "308",
      "name": "Debug Log After: Select GitLab Management Issues Candidate -> Set GitLab Management Issues Candidate Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1580,
        280
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Select GitLab Management Issues Candidate',\n  target: 'Set GitLab Management Issues Candidate Context',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "309",
      "name": "Debug Log Before: Set GitLab Management Issues Candidate Context <- Select GitLab Management Issues Candidate",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1380,
        280
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'after',\n  source: 'Set GitLab Management Issues Candidate Context',\n  target: 'Fetch Catalog (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "310",
      "name": "Debug Log After: Set GitLab Management Issues Candidate Context -> Fetch Catalog (Preview)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1660,
        280
      ]
    },
    {
      "parameters": {
        "jsCode": "const debugFlag = String($env.N8N_DEBUG_LOG || '').toLowerCase();\nconst enabled = ['1', 'true', 'yes', 'y', 'on'].includes(debugFlag);\nif (!enabled) {\n  return $input.all();\n}\n\nconst maxItemsRaw = $env.N8N_DEBUG_LOG_MAX_ITEMS || '5';\nconst maxItems = Number.isFinite(Number(maxItemsRaw)) ? Number(maxItemsRaw) : 5;\nconst items = $input.all();\nconst sample = items.slice(0, Math.max(0, maxItems));\n\nfunction mask(value, depth = 0) {\n  if (depth > 4) return '[max-depth]';\n  if (Array.isArray(value)) {\n    return value.map((entry) => mask(entry, depth + 1));\n  }\n  if (value && typeof value === 'object') {\n    const result = {};\n    for (const [key, raw] of Object.entries(value)) {\n      const keyLower = String(key).toLowerCase();\n      if (keyLower.includes('token') || keyLower.includes('secret') || keyLower.includes('password') || keyLower.includes('authorization') || keyLower.includes('cookie') || keyLower.includes('api_key') || keyLower.includes('apikey')) {\n        result[key] = '***';\n      } else {\n        result[key] = mask(raw, depth + 1);\n      }\n    }\n    return result;\n  }\n  return value;\n}\n\nconst payload = sample.map((item) => mask(item.json));\nconst line = JSON.stringify({\n  tag: 'n8n_debug',\n  phase: 'before',\n  source: 'Set GitLab Management Issues Candidate Context',\n  target: 'Fetch Catalog (Preview)',\n  output_index: 0,\n  items_total: items.length,\n  items: payload\n});\n\ntry {\n  if (this?.logger?.info) {\n    this.logger.info(line);\n  } else {\n    console.log(line);\n  }\n} catch (error) {\n  console.log(line);\n}\n\nconst observerUrl = $env.N8N_OBSERVER_URL;\nconst observerToken = $env.N8N_OBSERVER_TOKEN;\n\nif (observerUrl && observerToken) {\n  let event = null;\n  try {\n    event = JSON.parse(line);\n  } catch (error) {\n    event = { tag: 'n8n_debug', raw: String(line ?? '') };\n  }\n\n  const payloadForObserver = {\n    kind: 'n8n.debug_log',\n    realm: $env.N8N_OBSERVER_REALM ?? null,\n    workflow: $workflow.name,\n    execution_id: $execution.id,\n    sent_at: new Date().toISOString(),\n    event\n  };\n\n  try {\n    await this.helpers.httpRequest({\n      method: 'POST',\n      url: observerUrl,\n      json: true,\n      headers: {\n        'X-Observer-Token': observerToken\n      },\n      body: payloadForObserver,\n      timeout: 5000\n    });\n  } catch (error) {\n    // Observability must never break production workflows.\n  }\n}\nreturn $input.all();\n",
        "mode": "runOnceForAllItems"
      },
      "id": "311",
      "name": "Debug Log Before: Fetch Catalog (Preview) <- Set GitLab Management Issues Candidate Context",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1500,
        300
      ]
    }
  ],
  "connections": {
    "Webhook (jobs.Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: Webhook (jobs.Preview) -> Apply RAG Route (Input)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Job Plan + Token": {
      "main": [
        [
          {
            "node": "Debug Log After: Build Job Plan + Token -> Save Pending Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Save Pending Approval": {
      "main": [
        [
          {
            "node": "Debug Log After: Save Pending Approval -> Return Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Webhook (jobs.enqueue)": {
      "main": [
        [
          {
            "node": "Debug Log After: Webhook (jobs.enqueue) -> Verify Token (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verify Token (enqueue)": {
      "main": [
        [
          {
            "node": "Debug Log After: Verify Token (enqueue) -> Load Context (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Context (enqueue)": {
      "main": [
        [
          {
            "node": "Debug Log After: Load Context (enqueue) -> Check Workflow Availability (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check Workflow Availability (enqueue)": {
      "main": [
        [
          {
            "node": "Debug Log After: Check Workflow Availability (enqueue) -> Consume Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Consume Approval": {
      "main": [
        [
          {
            "node": "Debug Log After: Consume Approval -> Ensure Approval Consumed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enrich RAG Route": {
      "main": [
        [
          {
            "node": "Debug Log After: Enrich RAG Route -> IF RAG Enabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF 既知エラーDB Mode": {
      "main": [
        [
          {
            "node": "Debug Log After: IF 既知エラーDB Mode -> Query 既知エラーDB Candidate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Debug Log After: IF 既知エラーDB Mode -> IF GitLab Management Issues Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query 既知エラーDB Candidate": {
      "main": [
        [
          {
            "node": "Debug Log After: Query 既知エラーDB Candidate -> Select 既知エラーDB Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set 既知エラーDB Candidate Context": {
      "main": [
        [
          {
            "node": "Debug Log After: Set 既知エラーDB Candidate Context -> Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query Problem Candidate": {
      "main": [
        [
          {
            "node": "Debug Log After: Query Problem Candidate -> Select Problem Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set Problem Candidate Context": {
      "main": [
        [
          {
            "node": "Debug Log After: Set Problem Candidate Context -> Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ensure Approval Consumed": {
      "main": [
        [
          {
            "node": "Debug Log After: Ensure Approval Consumed -> Enqueue Job Engine",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Enqueue Job Engine": {
      "main": [
        [
          {
            "node": "Debug Log After: Enqueue Job Engine -> Return Enqueue Ack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Record Prompt History (RAG)": {
      "main": [
        [
          {
            "node": "Debug Log After: Record Prompt History (RAG) -> OpenAI RAG Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI RAG Router": {
      "main": [
        [
          {
            "node": "Debug Log After: OpenAI RAG Router -> Parse RAG Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse RAG Response": {
      "main": [
        [
          {
            "node": "Debug Log After: Parse RAG Response -> IF RAG Route OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF RAG Route OK": {
      "main": [
        [
          {
            "node": "Debug Log After: IF RAG Route OK -> Enrich RAG Route",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Debug Log After: IF RAG Route OK -> RAG Router (Basic)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "RAG Router (Basic)": {
      "main": [
        [
          {
            "node": "Debug Log After: RAG Router (Basic) -> Enrich RAG Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Build Preview Prompt (JP)": {
      "main": [
        [
          {
            "node": "Debug Log After: Build Preview Prompt (JP) -> IF Prompt Override (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Record Prompt History (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: Record Prompt History (Preview) -> OpenAI Jobs Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Jobs Preview": {
      "main": [
        [
          {
            "node": "Debug Log After: OpenAI Jobs Preview -> Parse Preview Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Prompt Override (RAG)": {
      "main": [
        [
          {
            "node": "Debug Log After: IF Prompt Override (RAG) -> Load Prompt History (RAG)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Debug Log After: IF Prompt Override (RAG) -> Record Prompt History (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Prompt History (RAG)": {
      "main": [
        [
          {
            "node": "Debug Log After: Load Prompt History (RAG) -> Apply Stored Prompt (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Stored Prompt (RAG)": {
      "main": [
        [
          {
            "node": "Debug Log After: Apply Stored Prompt (RAG) -> OpenAI RAG Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF Prompt Override (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: IF Prompt Override (Preview) -> Load Prompt History (Preview)",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Debug Log After: IF Prompt Override (Preview) -> Record Prompt History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Prompt History (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: Load Prompt History (Preview) -> Apply Stored Prompt (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply Stored Prompt (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: Apply Stored Prompt (Preview) -> OpenAI Jobs Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select 既知エラーDB Candidate": {
      "main": [
        [
          {
            "node": "Debug Log After: Select 既知エラーDB Candidate -> Set 既知エラーDB Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select Problem Candidate": {
      "main": [
        [
          {
            "node": "Debug Log After: Select Problem Candidate -> Set Problem Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Fetch Catalog (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: Fetch Catalog (Preview) -> Load Feedback (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Feedback (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: Load Feedback (Preview) -> Attach Feedback (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Attach Feedback (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: Attach Feedback (Preview) -> Load Approval History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Load Approval History (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log After: Load Approval History (Preview) -> Attach Approval History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Attach Approval History (Preview)": {
      "main": [
        [
          {
            "node": "Build Preview Prompt (JP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Apply RAG Route (Input)": {
      "main": [
        [
          {
            "node": "Debug Log After: Apply RAG Route (Input) -> Enrich RAG Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF RAG Enabled": {
      "main": [
        [
          {
            "node": "Debug Log After: IF RAG Enabled -> IF 既知エラーDB Mode",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Debug Log After: IF RAG Enabled -> Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "IF GitLab Management Issues Mode": {
      "main": [
        [
          {
            "node": "Debug Log After: IF GitLab Management Issues Mode -> Query GitLab Management Issues Candidate",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Debug Log After: IF GitLab Management Issues Mode -> Query Problem Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Query GitLab Management Issues Candidate": {
      "main": [
        [
          {
            "node": "Debug Log After: Query GitLab Management Issues Candidate -> Select GitLab Management Issues Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Select GitLab Management Issues Candidate": {
      "main": [
        [
          {
            "node": "Debug Log After: Select GitLab Management Issues Candidate -> Set GitLab Management Issues Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set GitLab Management Issues Candidate Context": {
      "main": [
        [
          {
            "node": "Debug Log After: Set GitLab Management Issues Candidate Context -> Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Webhook (jobs.Preview) -> Apply RAG Route (Input)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Apply RAG Route (Input) <- Webhook (jobs.Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Apply RAG Route (Input) <- Webhook (jobs.Preview)": {
      "main": [
        [
          {
            "node": "Apply RAG Route (Input)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Build Job Plan + Token -> Save Pending Approval": {
      "main": [
        [
          {
            "node": "Debug Log Before: Save Pending Approval <- Build Job Plan + Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Save Pending Approval <- Build Job Plan + Token": {
      "main": [
        [
          {
            "node": "Save Pending Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Save Pending Approval -> Return Preview": {
      "main": [
        [
          {
            "node": "Debug Log Before: Return Preview <- Save Pending Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Return Preview <- Save Pending Approval": {
      "main": [
        [
          {
            "node": "Return Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Webhook (jobs.enqueue) -> Verify Token (enqueue)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Verify Token (enqueue) <- Webhook (jobs.enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Verify Token (enqueue) <- Webhook (jobs.enqueue)": {
      "main": [
        [
          {
            "node": "Verify Token (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Verify Token (enqueue) -> Load Context (enqueue)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Load Context (enqueue) <- Verify Token (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Load Context (enqueue) <- Verify Token (enqueue)": {
      "main": [
        [
          {
            "node": "Load Context (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Load Context (enqueue) -> Check Workflow Availability (enqueue)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Check Workflow Availability (enqueue) <- Load Context (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Check Workflow Availability (enqueue) <- Load Context (enqueue)": {
      "main": [
        [
          {
            "node": "Check Workflow Availability (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Check Workflow Availability (enqueue) -> Consume Approval": {
      "main": [
        [
          {
            "node": "Debug Log Before: Consume Approval <- Check Workflow Availability (enqueue)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Consume Approval <- Check Workflow Availability (enqueue)": {
      "main": [
        [
          {
            "node": "Consume Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Consume Approval -> Ensure Approval Consumed": {
      "main": [
        [
          {
            "node": "Debug Log Before: Ensure Approval Consumed <- Consume Approval",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Ensure Approval Consumed <- Consume Approval": {
      "main": [
        [
          {
            "node": "Ensure Approval Consumed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Enrich RAG Route -> IF RAG Enabled": {
      "main": [
        [
          {
            "node": "Debug Log Before: IF RAG Enabled <- Enrich RAG Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: IF RAG Enabled <- Enrich RAG Route": {
      "main": [
        [
          {
            "node": "IF RAG Enabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF 既知エラーDB Mode -> Query 既知エラーDB Candidate": {
      "main": [
        [
          {
            "node": "Debug Log Before: Query 既知エラーDB Candidate <- IF 既知エラーDB Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Query 既知エラーDB Candidate <- IF 既知エラーDB Mode": {
      "main": [
        [
          {
            "node": "Query 既知エラーDB Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF 既知エラーDB Mode -> IF GitLab Management Issues Mode": {
      "main": [
        [
          {
            "node": "Debug Log Before: IF GitLab Management Issues Mode <- IF 既知エラーDB Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: IF GitLab Management Issues Mode <- IF 既知エラーDB Mode": {
      "main": [
        [
          {
            "node": "IF GitLab Management Issues Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Query 既知エラーDB Candidate -> Select 既知エラーDB Candidate": {
      "main": [
        [
          {
            "node": "Debug Log Before: Select 既知エラーDB Candidate <- Query 既知エラーDB Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Select 既知エラーDB Candidate <- Query 既知エラーDB Candidate": {
      "main": [
        [
          {
            "node": "Select 既知エラーDB Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Set 既知エラーDB Candidate Context -> Fetch Catalog (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Fetch Catalog (Preview) <- Set 既知エラーDB Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Fetch Catalog (Preview) <- Set 既知エラーDB Candidate Context": {
      "main": [
        [
          {
            "node": "Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Query Problem Candidate -> Select Problem Candidate": {
      "main": [
        [
          {
            "node": "Debug Log Before: Select Problem Candidate <- Query Problem Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Select Problem Candidate <- Query Problem Candidate": {
      "main": [
        [
          {
            "node": "Select Problem Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Set Problem Candidate Context -> Fetch Catalog (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Fetch Catalog (Preview) <- Set Problem Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Fetch Catalog (Preview) <- Set Problem Candidate Context": {
      "main": [
        [
          {
            "node": "Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Ensure Approval Consumed -> Enqueue Job Engine": {
      "main": [
        [
          {
            "node": "Debug Log Before: Enqueue Job Engine <- Ensure Approval Consumed",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Enqueue Job Engine <- Ensure Approval Consumed": {
      "main": [
        [
          {
            "node": "Enqueue Job Engine",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Enqueue Job Engine -> Return Enqueue Ack": {
      "main": [
        [
          {
            "node": "Debug Log Before: Return Enqueue Ack <- Enqueue Job Engine",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Return Enqueue Ack <- Enqueue Job Engine": {
      "main": [
        [
          {
            "node": "Return Enqueue Ack",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Record Prompt History (RAG) -> OpenAI RAG Router": {
      "main": [
        [
          {
            "node": "Debug Log Before: OpenAI RAG Router <- Record Prompt History (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: OpenAI RAG Router <- Record Prompt History (RAG)": {
      "main": [
        [
          {
            "node": "OpenAI RAG Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: OpenAI RAG Router -> Parse RAG Response": {
      "main": [
        [
          {
            "node": "Debug Log Before: Parse RAG Response <- OpenAI RAG Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Parse RAG Response <- OpenAI RAG Router": {
      "main": [
        [
          {
            "node": "Parse RAG Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Parse RAG Response -> IF RAG Route OK": {
      "main": [
        [
          {
            "node": "Debug Log Before: IF RAG Route OK <- Parse RAG Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: IF RAG Route OK <- Parse RAG Response": {
      "main": [
        [
          {
            "node": "IF RAG Route OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF RAG Route OK -> Enrich RAG Route": {
      "main": [
        [
          {
            "node": "Debug Log Before: Enrich RAG Route <- IF RAG Route OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Enrich RAG Route <- IF RAG Route OK": {
      "main": [
        [
          {
            "node": "Enrich RAG Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF RAG Route OK -> RAG Router (Basic)": {
      "main": [
        [
          {
            "node": "Debug Log Before: RAG Router (Basic) <- IF RAG Route OK",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: RAG Router (Basic) <- IF RAG Route OK": {
      "main": [
        [
          {
            "node": "RAG Router (Basic)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: RAG Router (Basic) -> Enrich RAG Route": {
      "main": [
        [
          {
            "node": "Debug Log Before: Enrich RAG Route <- RAG Router (Basic)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Enrich RAG Route <- RAG Router (Basic)": {
      "main": [
        [
          {
            "node": "Enrich RAG Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Build Preview Prompt (JP) -> IF Prompt Override (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: IF Prompt Override (Preview) <- Build Preview Prompt (JP)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: IF Prompt Override (Preview) <- Build Preview Prompt (JP)": {
      "main": [
        [
          {
            "node": "IF Prompt Override (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Record Prompt History (Preview) -> OpenAI Jobs Preview": {
      "main": [
        [
          {
            "node": "Debug Log Before: OpenAI Jobs Preview <- Record Prompt History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: OpenAI Jobs Preview <- Record Prompt History (Preview)": {
      "main": [
        [
          {
            "node": "OpenAI Jobs Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: OpenAI Jobs Preview -> Parse Preview Response": {
      "main": [
        [
          {
            "node": "Debug Log Before: Parse Preview Response <- OpenAI Jobs Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Parse Preview Response <- OpenAI Jobs Preview": {
      "main": [
        [
          {
            "node": "Parse Preview Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF Prompt Override (RAG) -> Load Prompt History (RAG)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Load Prompt History (RAG) <- IF Prompt Override (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Load Prompt History (RAG) <- IF Prompt Override (RAG)": {
      "main": [
        [
          {
            "node": "Load Prompt History (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF Prompt Override (RAG) -> Record Prompt History (RAG)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Record Prompt History (RAG) <- IF Prompt Override (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Record Prompt History (RAG) <- IF Prompt Override (RAG)": {
      "main": [
        [
          {
            "node": "Record Prompt History (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Load Prompt History (RAG) -> Apply Stored Prompt (RAG)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Apply Stored Prompt (RAG) <- Load Prompt History (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Apply Stored Prompt (RAG) <- Load Prompt History (RAG)": {
      "main": [
        [
          {
            "node": "Apply Stored Prompt (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Apply Stored Prompt (RAG) -> OpenAI RAG Router": {
      "main": [
        [
          {
            "node": "Debug Log Before: OpenAI RAG Router <- Apply Stored Prompt (RAG)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: OpenAI RAG Router <- Apply Stored Prompt (RAG)": {
      "main": [
        [
          {
            "node": "OpenAI RAG Router",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF Prompt Override (Preview) -> Load Prompt History (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Load Prompt History (Preview) <- IF Prompt Override (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Load Prompt History (Preview) <- IF Prompt Override (Preview)": {
      "main": [
        [
          {
            "node": "Load Prompt History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF Prompt Override (Preview) -> Record Prompt History (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Record Prompt History (Preview) <- IF Prompt Override (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Record Prompt History (Preview) <- IF Prompt Override (Preview)": {
      "main": [
        [
          {
            "node": "Record Prompt History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Load Prompt History (Preview) -> Apply Stored Prompt (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Apply Stored Prompt (Preview) <- Load Prompt History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Apply Stored Prompt (Preview) <- Load Prompt History (Preview)": {
      "main": [
        [
          {
            "node": "Apply Stored Prompt (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Apply Stored Prompt (Preview) -> OpenAI Jobs Preview": {
      "main": [
        [
          {
            "node": "Debug Log Before: OpenAI Jobs Preview <- Apply Stored Prompt (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: OpenAI Jobs Preview <- Apply Stored Prompt (Preview)": {
      "main": [
        [
          {
            "node": "OpenAI Jobs Preview",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Select 既知エラーDB Candidate -> Set 既知エラーDB Candidate Context": {
      "main": [
        [
          {
            "node": "Debug Log Before: Set 既知エラーDB Candidate Context <- Select 既知エラーDB Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Set 既知エラーDB Candidate Context <- Select 既知エラーDB Candidate": {
      "main": [
        [
          {
            "node": "Set 既知エラーDB Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Select Problem Candidate -> Set Problem Candidate Context": {
      "main": [
        [
          {
            "node": "Debug Log Before: Set Problem Candidate Context <- Select Problem Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Set Problem Candidate Context <- Select Problem Candidate": {
      "main": [
        [
          {
            "node": "Set Problem Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Fetch Catalog (Preview) -> Load Feedback (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Load Feedback (Preview) <- Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Load Feedback (Preview) <- Fetch Catalog (Preview)": {
      "main": [
        [
          {
            "node": "Load Feedback (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Load Feedback (Preview) -> Attach Feedback (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Attach Feedback (Preview) <- Load Feedback (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Attach Feedback (Preview) <- Load Feedback (Preview)": {
      "main": [
        [
          {
            "node": "Attach Feedback (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Attach Feedback (Preview) -> Load Approval History (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Load Approval History (Preview) <- Attach Feedback (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Load Approval History (Preview) <- Attach Feedback (Preview)": {
      "main": [
        [
          {
            "node": "Load Approval History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Load Approval History (Preview) -> Attach Approval History (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Attach Approval History (Preview) <- Load Approval History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Attach Approval History (Preview) <- Load Approval History (Preview)": {
      "main": [
        [
          {
            "node": "Attach Approval History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Attach Approval History (Preview) -> Build Job Plan + Token": {
      "main": [
        [
          {
            "node": "Debug Log Before: Build Job Plan + Token <- Attach Approval History (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Build Job Plan + Token <- Attach Approval History (Preview)": {
      "main": [
        [
          {
            "node": "Build Job Plan + Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Apply RAG Route (Input) -> Enrich RAG Route": {
      "main": [
        [
          {
            "node": "Debug Log Before: Enrich RAG Route <- Apply RAG Route (Input)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Enrich RAG Route <- Apply RAG Route (Input)": {
      "main": [
        [
          {
            "node": "Enrich RAG Route",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF RAG Enabled -> IF 既知エラーDB Mode": {
      "main": [
        [
          {
            "node": "Debug Log Before: IF 既知エラーDB Mode <- IF RAG Enabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: IF 既知エラーDB Mode <- IF RAG Enabled": {
      "main": [
        [
          {
            "node": "IF 既知エラーDB Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF RAG Enabled -> Fetch Catalog (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Fetch Catalog (Preview) <- IF RAG Enabled",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Fetch Catalog (Preview) <- IF RAG Enabled": {
      "main": [
        [
          {
            "node": "Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF GitLab Management Issues Mode -> Query GitLab Management Issues Candidate": {
      "main": [
        [
          {
            "node": "Debug Log Before: Query GitLab Management Issues Candidate <- IF GitLab Management Issues Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Query GitLab Management Issues Candidate <- IF GitLab Management Issues Mode": {
      "main": [
        [
          {
            "node": "Query GitLab Management Issues Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: IF GitLab Management Issues Mode -> Query Problem Candidate": {
      "main": [
        [
          {
            "node": "Debug Log Before: Query Problem Candidate <- IF GitLab Management Issues Mode",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Query Problem Candidate <- IF GitLab Management Issues Mode": {
      "main": [
        [
          {
            "node": "Query Problem Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Query GitLab Management Issues Candidate -> Select GitLab Management Issues Candidate": {
      "main": [
        [
          {
            "node": "Debug Log Before: Select GitLab Management Issues Candidate <- Query GitLab Management Issues Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Select GitLab Management Issues Candidate <- Query GitLab Management Issues Candidate": {
      "main": [
        [
          {
            "node": "Select GitLab Management Issues Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Select GitLab Management Issues Candidate -> Set GitLab Management Issues Candidate Context": {
      "main": [
        [
          {
            "node": "Debug Log Before: Set GitLab Management Issues Candidate Context <- Select GitLab Management Issues Candidate",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Set GitLab Management Issues Candidate Context <- Select GitLab Management Issues Candidate": {
      "main": [
        [
          {
            "node": "Set GitLab Management Issues Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log After: Set GitLab Management Issues Candidate Context -> Fetch Catalog (Preview)": {
      "main": [
        [
          {
            "node": "Debug Log Before: Fetch Catalog (Preview) <- Set GitLab Management Issues Candidate Context",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Debug Log Before: Fetch Catalog (Preview) <- Set GitLab Management Issues Candidate Context": {
      "main": [
        [
          {
            "node": "Fetch Catalog (Preview)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Parse Preview Response": {
      "main": [
        [
          {
            "node": "Force Auto Enqueue (Monitoring)",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Force Auto Enqueue (Monitoring)": {
      "main": [
        [
          {
            "node": "Build Job Plan + Token",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionTimeout": 300
  },
  "versionId": "00000000-0000-0000-0000-000000000000",
  "meta": {
    "aiops": {
      "purpose": "Orchestrator: preview (plan+token) and enqueue (verify/consume)"
    }
  }
}
