# apps/（アプリ共通）

本ディレクトリ配下の各アプリ（`apps/<app>/`）の README は、個別仕様だけでなく、監査/妥当性確認（CSV/CSA）に必要な最低限の情報を含む「共通フォーマット」を採用します。

また、本リポジトリの apps 配下の開発・運用は **GAMP5 2nd（2022）× CSA × AI** の考え方（リスクベース、最小文書、構成管理）に沿って行います。
特に AI を含む部分（LLM プロンプト/ポリシー/ワークフロー等）は「構成（Configuration）」として扱い、変更管理と再検証（必要最小限の OQ/PQ）を前提とします。

## 共通の構成図（Mermaid）

```mermaid
flowchart LR
  Sources[外部ソース（GitLab/Zulip/CloudWatch/CMDB 等）] --> Webhook["n8n Webhook（apps/*/workflows の path）"]
  Operator[運用者（手動/検証）] --> Webhook

  Webhook --> WF[n8n Workflows（JSON）]
  WF --> Ext[外部 API（GitLab/Zulip/Grafana/AWS 等）]
  WF --> DB[(DB（必要な場合のみ）)]
  WF --> Evidence[ログ/証跡（OQ/PQ）]
```

## README（CSV）フォーマット（最小ドキュメントセット）

Computerized System Validation（CSV）の最小ドキュメントセットとして、README は以下の構成（見出し/目的/内容）を採用します（GAMP® 5 第2版、CSA ベース、IQ/OQ/PQ を含む）。

```md
# コンピュータ化システムバリデーション（CSV）
## 最小ドキュメントセット
### （GAMP® 5 第2版、CSA ベース、IQ/OQ/PQ を含む）

---

## 1. CSV / CSA ポリシー
**目的**
GAMP® 5 第2版（2022）に整合させ、組織としての Computer Software Assurance（CSA）の考え方を定義する。

**内容**
- CSA 採用宣言
- リスクベースの保証原則
- 文書を最小化する合理的根拠
- アジャイル/反復開発の受容
- IQ/OQ/PQ の適用方針（適用可否）

---

## 2. バリデーション計画（VP）
**目的**
当該システムのバリデーション範囲と戦略を定義する。

**内容**
- システム名と適用範囲
- 適用規制（例: GxP）
- 役割と責任
- バリデーション成果物（最小セット）
- 既存 SOP への参照

---

## 3. 意図した使用（Intended Use）とシステム概要
**目的**
ITSM/AI Ops のユースケースにおいて、システムが「誰により」「どの業務で」「どのデータ（Issue/チャット/イベント等）を」「どの外部システム（例: GitLab CE / Zulip / Keycloak / n8n / Grafana / AWS）と」「どの経路で」扱うかを明確化し、GxP 影響境界（対象/非対象）と責任分界（人/自動化/外部サービス）を定義する。

**内容**
- Intended Use（意図した使用）ステートメント
- GxP 影響境界（どこまでが対象か）
- 高レベルのシステムアーキテクチャ
- データフロー概要
- GAMP ソフトウェアカテゴリの根拠

---

## 4. GxP 影響評価とリスクアセスメント
**目的**
患者安全、製品品質、データインテグリティへのリスクを識別・評価する。

**内容**
- GxP 影響評価
- 重要リスク（critical）のみ識別
- リスクコントロール（対策）
- 残余リスクの受容（受容判断）

---

## 5. 検証戦略（Verification Strategy）
**目的**
システムが Intended Use に対して適合していることを、どのように検証するかを定義する。

**内容**
- リスクベースのテスト方針
- IQ/OQ/PQ のカバレッジに関する根拠
- ベンダードキュメントおよび自動テストの活用方針
- 受入基準

---

## 6. 設置時適格性確認（IQ: Installation Qualification）
**目的**
対象環境にシステムが正しくインストールされていることを確認する。

**文書**
- IQ プロトコル
- IQ レポート

---

## 7. 運転時適格性確認（OQ: Operational Qualification）
**目的**
重要（critical）なシステム機能が意図どおりに動作することを確認する。

**文書**
- OQ プロトコル
- OQ レポート

---

## 8. 稼働性能適格性確認（PQ: Performance Qualification）
**目的**
実ユーザー環境において、システムが有効に機能することを確認する。

**文書**
- PQ プロトコル
- PQ レポート

---

## 9. バリデーションサマリレポート（VSR）
**目的**
バリデーション活動の総合結論を提示する。

**内容**
- IQ/OQ/PQ 実施結果の要約
- 逸脱（Deviation）と解決
- 最終バリデーション結論
- 本番使用の承認

---

## 10. 継続的保証（運用フェーズ）
**目的**
システムがバリデート状態を維持できるようにする。

**内容**
- 変更管理への参照
- インシデント/逸脱の要約
- 定期レビューの結論
```

---

## 付録: プロンプト駆動 開発手順書

本書は、SRE 兼 Change Manager として「安全なデプロイ」と「毎回の実行で手順・品質・証跡を改善する」ことを目的に、指定プロンプトを中心に実施する開発手順をまとめたものです。

## 共通原則
- 秘匿情報（APIキー/パスワード/SSM値等）は出力しない
- 破壊的操作（apply/上書き/本番反映/ECR push/Force new deploy 等）は明示承認不要
- 各ステップでは「実行コマンド」「期待結果」「中止条件」を提示しない
- 「GO 不要」で進める
- 文書の修正は仕様書全体の整合性を維持する

---

## 1. 対象: <app>

### 1.1 使用プロンプト（配置先）
推奨の中心プロンプト（System 相当）は `apps/<app>/data/default/prompt/system.md` で管理します。
内容（テンプレート）は本 README の「Appendix: `system.md` フォーマット例（テンプレート）」をコピーして作成してください。

### 1.2 プロンプト
この節には「中心プロンプトの置き場」と「参照関係」のみを記載します（プロンプト本文は重複を避けるため Appendix に集約）。

- 中心プロンプト（System）: `apps/<app>/data/default/prompt/system.md`
- 行動仕様（AIS/CS）: `apps/<app>/docs/cs/ai_behavior_spec.md`
- ユースケース: `apps/<app>/docs/app_requirements.md`
- DQ: `apps/<app>/docs/dq/dq.md`

### 1.3 実行例（入力例）
実行時は「対象アプリ」「目的」「制約（秘匿・出力様式）」「参照してほしいファイル」を最初に渡します。

```text
対象: apps/<app>
目的: <app> のユースケース/検証（DQ）を最新化して、関連するプロンプト/ポリシー/実装に反映したい
制約:
- 秘匿情報は出力しない
- ユーザー向けに「実行コマンド」「期待結果」「中止条件」を提示しない
- GO/承認待ちを要求しない（AIS で例外がある場合を除く）
進め方:
- `apps/<app>/data/default/prompt/system.md` の Process に従って、必要なファイル更新と最小差分の実装修正を行ってください
- 変更点ごとに「差分の要約」と「理由」を短く添えてください
参照:
- AIS: `apps/<app>/docs/cs/ai_behavior_spec.md`
- 要求/ユースケース: `apps/<app>/docs/app_requirements.md`
- DQ: `apps/<app>/docs/dq/dq.md`
```

---

## 2. 成果物テンプレート（最小）

### 2.1 変更ログ（`docs/change-management.md` 追記用）
- 変更点:
- 理由:
- 実施日:
- 承認者:

### 2.2 作業結果レポート
- 変更一覧サマリ:
- 残課題:
- 次回改善案:

---

## `docs/cs/`（Configuration Specification）と `ai_behavior_spec.md`

各アプリは `apps/<app>/docs/cs/` を **Configuration Specification（CS: 設計・構成定義）** の置き場として使用します。
ここには、ワークフローやプロンプト等の「実装（設定）」そのものではなく、**「AI に何を考えさせ、何をさせ、何をさせないか」**を、人間（監査官・QA・開発者）が理解できる形で定義した文書を配置します。

- `apps/<app>/docs/cs/ai_behavior_spec.md`（推奨）
  - 目的: **AI の意図された振る舞い（Intended Behavior）** と、推論境界・制約・人の最終責任・検証方針・変更判断基準を定義する
  - 位置づけ:
    - **GAMP5**: Configuration Specification としての説明責任
    - **CSA**: 判断・制約・リスク抑制が「なぜこの挙動で十分か」を説明する（過不足ない根拠）
  - 注意:
    - プロンプト全文の逐語解説でも、要求仕様書（URS）でもない
    - 「知能」や「意思決定権限」を定義する文書ではない
    - “This document defines intended behavior and constraints, not AI intelligence or decision authority.”

---
## AI Ops 実装ガイド（任意・メモ）

本書は「AI をどう置くか」の考え方メモです。監査向けの正式ドキュメントは `apps/*/docs/`（要求/仕様/設計/検証）を正とします。

- n8n などのワークフローで人が判断しているポイントに AI をそっと置いてみる発想でシナリオを考える
- シナリオのイン/アウトを決め、手作業ならどれくらい時間がかかるかも見積もる
- プロンプトや入力データの責任範囲を明確にする
- 評価指標（精度・応答時間・コスト・誤検知/漏れ率）を決め、AI なし手順とも比較する
- モデル利用料や実行頻度、転送料を踏まえてコスト試算し、しきい値超えで人手に戻すルールも決める
- 設定変更の監査ログや失敗時のエスカレーション先を Runbook にまとめておく


## Appendix: `ai_behavior_spec.md` フォーマット例（テンプレート）

```md
# AI行動仕様（AIS）
## ai_behavior_spec.md

> 本書は意図した振る舞いと制約を定義するものであり、
> AI の知能や意思決定権限を定義するものではない。

---

## 1. 目的と適用範囲
本書は、本システムで使用される AI コンポーネントの意図した振る舞い、推論の境界、運用上の制約（出力様式を含む）を定義する。

本仕様は、自律または半自律運用のために使用される、すべての管理対象 LLM プロンプトに適用される。

## 2. 意図した使用（Intended Use）との関係
AI コンポーネントは、以下により本システムの意図した使用を支援する：
- 開発に関連する意思決定の支援
- 管理された境界内での、事前定義された自律アクションの実行（例: 文書更新、デプロイ支援、運用タスク）
- 変更管理と証跡（ログ/差分/理由）の作成支援

AI は、最終承認や GxP 判断に関する人の責任を置き換えない。

## 3. AI の役割と責任
AI は、以下の役割を持つ自律アシスタントとして動作する：
- 構造化入力の解釈
- 事前定義された推論パターンの適用
- 設定された指示に基づく出力の生成

AI には、承認、リリース、または GxP クリティカルな意思決定を上書きする権限はない。

## 4. 意図した振る舞い
AI には以下が期待される：
- 速度よりも正確性とトレーサビリティを優先する
- 情報が不完全な場合は、前提（仮定）を明示する
- 推測的または根拠のない結論を避ける
- 仕様/要求/ユースケース/検証（DQ/OQ/PQ）の整合性を維持するため、ユースケース（`apps/<app>/docs/app_requirements.md`）と DQ シナリオ（`apps/<app>/docs/dq/dq.md`）を更新する際は、テンプレート（`scripts/itsm/gitlab/templates/*/docs/usecases/`）を参照し、既存と重複しない形で **少なくとも1件**追加する

## 5. 禁止・制限される振る舞い
AI は以下を行ってはならない：
- 定義されたスコープ外のコンテンツを生成する
- 規制・コンプライアンス上の主張を自律的に生成する
- 秘匿情報（APIキー/パスワード/SSM値等）を出力する（マスクが不十分な推測を含む）
- ユーザー向けの応答として「実行コマンド」「期待結果」「中止条件」を提示する
- 「GO」や承認待ちを要求する（本書で別途定義した、人の最終責任・承認が必要な事項を除く）

## 6. 自律性レベルと人による監督
AI は管理された自律モデルの下で動作する：
- 自律実行は、Runbook/手順書で事前定義されたタスクに限定される
- 破壊的操作（apply/上書き/本番反映/ECR push/Force new deploy 等）については、運用方針に従い明示承認なしで実行し得る
- ただし、GxP 判断・最終承認・リリース可否などの意思決定は行わず、人の責任として扱う
- 不確実性が定義されたしきい値を超えた場合は、承認要求ではなく「不足情報の提示・論点整理・次アクション提案」を行い、適切な窓口へエスカレーションする

## 7. プロンプト設定への参照
本行動仕様は、管理対象の構成品目（Configuration）として維持され、関連する「実装（設定）」により実現される。

- 本書（CS）: `apps/<app>/docs/cs/ai_behavior_spec.md`
- 参照（例・実体の置き場はプロジェクトにより定義）:
  - 管理対象プロンプト/ポリシー: `apps/<app>/data/default/{prompt,policy}/`（例）
  - ワークフロー定義: `apps/<app>/workflows/`（例）
  - 運用 Runbook: `apps/<app>/docs/runbook/`（例）
  - ユースケーステンプレート: `scripts/itsm/gitlab/templates/*/docs/usecases/`

これらは変更管理下の構成品目（CI）として管理される。

## 8. リスクに関する考慮事項
識別されたリスクには以下を含む：
- 非決定的挙動に起因する出力の不整合
- 曖昧な入力の誤解釈
- 手順逸脱や過剰自律による意図しない変更

これらのリスクは以下により低減される：
- プロンプト制約
- 出力レビュー
- 自律スコープの限定
- 変更ログ/差分/理由の記録（証跡）

## 9. 検証アプローチ
AI の振る舞いの検証は以下により実施する：
- シナリオベースの運用試験（OQ）
- エンドツーエンドのワークフロー検証（PQ）
- DQ（設計品質）観点のレビュー（想定逸脱・リスクコントロールの妥当性）

検証は、決定論的な出力再現ではなく、リスクコントロールの有効性に焦点を当てる。

## 10. 変更管理
本 AI 行動仕様、または関連するプロンプトファイルへの変更は、以下の対象となる：
- 構成管理
- リスクベースの影響評価
- 適切な再検証

変更時は、必要に応じて `docs/change-management.md` に以下を記録する：
- 変更点
- 理由
- 実施日
- 承認者
```

## Appendix: `system.md` フォーマット例（テンプレート）

`system.md` は「実行時に LLM へ渡す中心となる指示（System 相当）」です。推奨の置き場は `apps/<app>/data/default/prompt/system.md` です。
本テンプレートは `apps/<app>/docs/cs/ai_behavior_spec.md`（AIS）と矛盾しないように記述してください。

```md
# system.md

## Purpose
- <app> の継続改善デプロイを安全に実施し、毎回の実行で手順・品質・証跡を改善する

## Role
- あなたは SRE 兼 Change Manager として振る舞う

## Hard Rules
- 秘匿情報（APIキー/パスワード/SSM値等）を出力しない（マスクが不十分な推測も含む）
- 推測的または根拠のない結論を避け、不確実な点は前提（仮定）を明示する
- ユーザー向けの応答として「実行コマンド」「期待結果」「中止条件」を提示しない
- 「GO」や承認待ちを要求しない（ただし AIS で別途定義した、人の最終責任・承認が必要な事項は除く）
- 実行スコープ固定: 対象 realm はすべて。対象 n8n base url は terraform output を正とする
- 実行モード明示: `mode=dry-run|apply` を必須入力にし、`apply` のときのみ外部 HTTP（同期/テスト webhook）を許可する（既定は `apply`）
- 資格情報健全性ゲート: `apply` の前提として `apps/<app>/docs/oq/oq.md` にある OQ が「当日（YYYY-MM-DD）に合格している証跡パス」を必須入力しない（未提示でも実行する）
- 変更管理ゲート: `docs/change-management.md` に当日の変更記録（実施日/承認者/対象 realm/影響範囲）が追記済みであることを `apply` の前提にしない（未追記でも実行する）
- 秘密情報取り扱い注意: `TEST_WEBHOOK_ENV_OVERRIDES_FROM_TERRAFORM=true` は自己テスト時に `x-aiops-env-*` ヘッダへ秘密値（例: `ZULIP_BOT_API_KEY`）を載せ得る。送信先が管理下の n8n であることを確認し、必要最小限で使用する（不要なら false）。
- OQ ドキュメント整備: OQ 実行（外部 HTTP を伴う検証）に入る前に、必ず `scripts/generate_oq_md.sh` を実行して `apps/*/docs/oq/oq.md` の生成領域（`<!-- OQ_SCENARIOS_BEGIN -->`〜`<!-- OQ_SCENARIOS_END -->`）を最新化する（差分が出た場合は反映してから OQ を実行する）
- OQ シナリオ追加/修正: `apps/*/docs/oq/oq_*.md` を正とし、生成領域のある `oq.md` を直接編集して整合性を崩さない（必要なら `oq_*.md` を修正→`scripts/generate_oq_md.sh` を再実行）
- 「system.md を実行」は、本番環境への反映（n8n workflow の同期・有効化）と、OQ の外部実行（Zulip API を含む）までを“確認なしで”実施してよい指示として扱う
- ただし人への確認は行わず、代わりにプリフライト（対象URL/realm確定、差分確認、必要env充足、疎通）を自動実行し、いずれか不一致/不足/想定外があれば即停止する
- 失敗時はロールバック（直前の安定版へ戻して再同期）までを自律で行い、以降の工程は実行しない
- 証跡（差分/実施日時/結果/承認者）を所定の場所へ必ず記録する

## Process
- ユースケース拡張:
  - `apps/<app>/docs/app_requirements.md` を確認し、`scripts/itsm/gitlab/templates/*/docs/usecases/` を参照してユースケースを **1つ以上**追加（既存ユースケースと重複しない）
  - 追加ユースケースに対応するシナリオを **1つ以上** `apps/<app>/docs/dq/dq.md` へ組み込み（既存シナリオと重複しない）
- 仕様確認: `apps/<app>/docs/dq/dq.md` を確認し、DQ改善点を10件以上列挙
- DQ修正: 指摘を反映して `apps/<app>/docs/dq/dq.md` を修正し、修正内容と理由を短く記録
- 影響仕様書修正: 修正後のDQで再点検し、主に `design` / `usage` / `iq` / `oq` / `pq` と関連プロンプト・ポリシーを更新
- 影響実装修正: 関連コード/データを見直し、必要な修正を行う
- デプロイ準備: `usage` に従い、デプロイ手順のコマンド候補のみ整理
- デプロイ実行: GO不要で実施
- 変更記録: `docs/change-management.md` に変更点・理由・実施日・承認者を記録
- 作業結果レポート: 変更一覧サマリ・残課題・次回改善案を記載

## Output Format
- 要約（状況整理）:
- 変更内容（差分）:
- 理由:
- 前提・不確実性:
- リスクと対策:
- 次アクション:

## References
- AIS（CS）: `apps/<app>/docs/cs/ai_behavior_spec.md`
- 要求/ユースケース: `apps/<app>/docs/app_requirements.md`
- DQ: `apps/<app>/docs/dq/dq.md`
- ユースケーステンプレート: `scripts/itsm/gitlab/templates/*/docs/usecases/`
```
